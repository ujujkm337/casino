<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–û–Ω–ª–∞–π–Ω –ë–ª—ç–∫–¥–∂–µ–∫</title>
    <style>
        /*
        ================================
        –û–ë–©–ò–ï CSS –°–¢–ò–õ–ò (–¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö) - –û—Å—Ç–∞–≤–ª–µ–Ω—ã –ø–æ –∑–∞–ø—Ä–æ—Å—É
        ================================
        */
        :root {
            --bg-color: #03040a;
            --accent-color: #00ffaa;
            --secondary-color: #9b56ff;
            --text-color: #e6f7ff;
            --red-color: #ff4757;
            --black-color: #1e272e;
            --main-font: 'Inter', sans-serif;
            --card-color: #f0f0f0;
            --card-suit-red: #ff4757;
            --card-suit-black: #1e272e;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: var(--main-font);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            overflow-x: hidden;
            text-align: center; /* –î–æ–±–∞–≤–ª–µ–Ω–æ –¥–ª—è —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞ */
        }
        
        body.win-flash { animation: win-pulse 0.2s 5 alternate; background-color: #1a222c; }
        @keyframes win-pulse {
            from { box-shadow: 0 0 10px var(--accent-color); }
            to { box-shadow: 0 0 60px var(--accent-color); }
        }

        .casino-wrapper {
            width: 95%;
            max-width: 600px;
            padding: 10px 0;
            box-sizing: border-box;
        }

        .game-container {
            padding: 15px;
            border-radius: 15px;
            background: rgba(1, 1, 1, 0.4);
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.5), 0 0 30px var(--secondary-color);
            border: 2px solid var(--secondary-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        .header-controls {
            display: flex;
            gap: 15px;
            align-items: center;
            width: 100%;
            justify-content: space-around;
        }
        .display { font-size: 1.1em; font-weight: 700; color: var(--text-color); padding: 5px 15px; border-radius: 5px; border: 1px dashed rgba(255, 255, 255, 0.2); }
        .bet-input-group { display: flex; align-items: center; gap: 5px; }
        .bet-input-group input { width: 70px; padding: 5px; border-radius: 5px; border: 1px solid var(--accent-color); background-color: var(--bg-color); color: var(--text-color); text-align: center; }

        .main-button { padding: 15px 30px; font-size: 1.5em; font-weight: 800; border: none; border-radius: 10px; cursor: pointer; background: linear-gradient(90deg, var(--secondary-color), var(--accent-color)); color: var(--bg-color); box-shadow: 0 5px 20px rgba(0, 255, 170, 0.4); transition: all 0.2s ease; text-transform: uppercase; }
        .main-button:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 7px 25px rgba(0, 255, 170, 0.8); }
        .main-button:disabled { background: #555; box-shadow: none; cursor: not-allowed; opacity: 0.6; }


        /* ----- –ë–ª—ç–∫–¥–∂–µ–∫ –°—Ç–∏–ª–∏ (–ê–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–ª—è –æ–Ω–ª–∞–π–Ω) ----- */
        .hand-container { 
            text-align: center; 
            min-height: 55px; 
            margin-bottom: 15px;
            display: flex; 
            justify-content: center;
            gap: 5px;
        }
        .card-container { display: inline-block; }
        .card { 
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            width: 45px; 
            height: 70px; 
            font-size: 1em;
            background-color: var(--card-color); 
            border: 1px solid #777; 
            border-radius: 6px; 
            box-shadow: 1px 1px 3px rgba(0, 0, 0, 0.5); 
            text-align: center;
            font-weight: 700;
            color: var(--card-suit-black);
            padding: 2px 0;
            box-sizing: border-box;
        }
        .red-suit { color: var(--card-suit-red); }
        .card-suit-symbol { font-size: 1.2em; line-height: 1; }
        .card-back { background-color: #555; border: 3px solid var(--secondary-color); color: var(--text-color); font-size: 1.5em; display: flex; justify-content: center; align-items: center; }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –ª–æ–±–±–∏ */
        .table-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border: 1px solid var(--accent-color);
            border-radius: 8px;
            background: rgba(0, 255, 170, 0.1);
        }
        .table-item span { font-weight: bold; }

    </style>
    <script src="/socket.io/socket.io.js"></script>
</head>
<body>
    <div class="casino-wrapper">
        <div class="game-container">
            <a href="index.html" class="main-button" style="width: auto; padding: 5px 10px; font-size: 1em; align-self: flex-start;">‚Üê –ù–∞–∑–∞–¥</a>
            <div class="header-controls" style="justify-content: center;">
                <div class="display" id="balanceDisplay">–ë–ê–õ–ê–ù–°: 0</div>
            </div>
            
            <h1 style="color:var(--accent-color);">üÉè –û–ù–õ–ê–ô–ù –ë–õ–≠–ö–î–ñ–ï–ö</h1>
            <div class="display" id="messageDisplay" style="width: 100%; text-align: center; color: var(--text-color);">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</div>
            
            <div id="lobbyView" style="width: 100%; max-width: 450px; display: none;">
                <h3 style="color:var(--secondary-color); margin-top: 5px;">–î–û–°–¢–£–ü–ù–´–ï –°–¢–û–õ–´</h3>
                <div id="tablesList" style="display:flex; flex-direction:column; gap:10px;">
                    </div>
            </div>
            
            <div id="gameView" style="display: none; width: 100%; max-width: 450px;">
                
                <h3 style="color:var(--red-color); margin-bottom: 0;">–î–ò–õ–ï–† <span id="dealerScore"></span></h3>
                <div id="dealerHand" class="hand-container"></div>
                
                <h3 style="color:var(--accent-color); margin-bottom: 0;">–í–´ <span id="playerScore"></span></h3>
                <div id="playerHand" class="hand-container"></div>
                
                <div id="betControls" style="margin: 20px 0; display:none; display:flex; justify-content:center; gap:10px;">
                    <input type="number" id="betAmount" value="50" min="10" class="bet-input-group" style="width: 100px;">
                    <button id="placeBetBtn" class="main-button" style="padding: 10px 20px; font-size: 1.2em;">–ü–û–°–¢–ê–í–ò–¢–¨</button>
                </div>
                
                <div id="actionButtons" style="margin: 20px 0; display: none; display: flex; gap: 10px; justify-content:center;">
                    <button id="hitBtn" class="main-button" style="padding: 10px 20px; font-size: 1.2em;" disabled>–í–ó–Ø–¢–¨ (HIT)</button>
                    <button id="standBtn" class="main-button" style="padding: 10px 20px; font-size: 1.2em;" disabled>–°–¢–û–ü (STAND)</button>
                </div>

                <button id="leaveTableBtn" class="main-button" style="margin-top: 15px; background: #555; box-shadow: none; padding: 10px 20px; font-size: 1.2em;">–í–´–ô–¢–ò –ò–ó –ö–û–ú–ù–ê–¢–´</button>
            </div>
        </div>
    </div>

    <script>
        // --- JS –õ–æ–≥–∏–∫–∞ –ö–ª–∏–µ–Ω—Ç–∞ ---
        const socket = io();
        let balance = parseInt(localStorage.getItem('casinoBalance')) || 1000;
        let playerId = null;
        let currentTableId = null;

        // --- –£–¢–ò–õ–ò–¢–´ UI ---
        function renderCard(cardData, targetElementId, faceUp = true) {
            const container = document.getElementById(targetElementId);
            const cardElement = document.createElement('div');
            cardElement.className = 'card-container';
            
            const rank = cardData.length > 1 ? cardData.slice(0, -1) : '?';
            const suit = cardData.length > 1 ? cardData.slice(-1) : '?';
            
            const suitsMap = { 'C': '‚ô£', 'D': '‚ô¶', 'H': '‚ô•', 'S': '‚ô†' };
            const isRed = suit === 'H' || suit === 'D';
            const suitSymbol = suitsMap[suit] || '?';
            
            if (!faceUp) {
                cardElement.innerHTML = `<div class="card card-back">BJ</div>`;
            } else {
                cardElement.innerHTML = `
                    <div class="card ${isRed ? 'red-suit' : 'black-suit'}">
                        <span style="align-self: flex-start; margin-left: 3px; font-size: 0.8em;">${rank}</span>
                        <span class="card-suit-symbol">${suitSymbol}</span>
                        <span style="align-self: flex-end; margin-right: 3px; font-size: 0.8em; transform:rotate(180deg);">${rank}</span>
                    </div>
                `;
            }
            container.appendChild(cardElement);
        }

        function updateGlobalBalance(newBalance) {
            balance = newBalance;
            localStorage.setItem('casinoBalance', balance);
            document.getElementById('balanceDisplay').textContent = `–ë–ê–õ–ê–ù–°: ${balance}`;
        }

        function updateDisplay(msg = '–°–¥–µ–ª–∞–π—Ç–µ —Å—Ç–∞–≤–∫—É –∏–ª–∏ –∂–¥–∏—Ç–µ —Ö–æ–¥–∞.') {
            document.getElementById('messageDisplay').innerHTML = msg;
        }

        function clearHands() {
            document.getElementById('dealerHand').innerHTML = '';
            document.getElementById('playerHand').innerHTML = '';
            document.getElementById('dealerScore').textContent = '';
            document.getElementById('playerScore').textContent = '';
        }
        
        function showLobby() {
            document.getElementById('lobbyView').style.display = 'flex';
            document.getElementById('gameView').style.display = 'none';
            currentTableId = null;
            clearHands();
            updateDisplay('–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–æ–ª –¥–ª—è –∏–≥—Ä—ã.');
            socket.emit('auth_request'); // –ó–∞–ø—Ä–æ—Å —Å–ø–∏—Å–∫–∞ —Å—Ç–æ–ª–æ–≤
        }

        function showGame() {
            document.getElementById('lobbyView').style.display = 'none';
            document.getElementById('gameView').style.display = 'flex';
        }
        
        // --- SOCKET.IO HANDLERS ---
        socket.on('connect', () => { socket.emit('auth_request'); });
        
        socket.on('auth_success', (data) => {
            playerId = data.id;
            updateGlobalBalance(data.balance);
            if (!currentTableId) {
                showLobby();
                renderTableList(data.tables);
            }
        });
        
        socket.on('error_message', (msg) => { alert('[–û—à–∏–±–∫–∞]: ' + msg); updateDisplay(`‚ùå –û—à–∏–±–∫–∞: ${msg}`); });

        function renderTableList(tables) {
            const list = document.getElementById('tablesList');
            list.innerHTML = '';
            tables.filter(t => t.gameType === 'Blackjack').forEach(table => {
                const item = document.createElement('div');
                item.className = 'table-item';
                item.innerHTML = `
                    <span>–°—Ç–æ–ª ${table.id.toUpperCase()} | –°—Ç–∞–≤–∫–∞ –æ—Ç ${table.minBet} | –ò–≥—Ä–æ–∫–æ–≤: ${table.currentPlayers}/${table.maxPlayers}</span>
                    <button class="main-button" onclick="joinTable('${table.id}', false)" style="width: auto; padding: 5px 15px; font-size: 1em;">–°–ï–°–¢–¨</button>
                `;
                list.appendChild(item);
            });
            // –î–æ–±–∞–≤–∏–º –æ—Ç–¥–µ–ª—å–Ω—É—é –∫–Ω–æ–ø–∫—É –¥–ª—è —Å—Ç–æ–ª–∞ —Å –±–æ—Ç–∞–º–∏, –µ—Å–ª–∏ —Ö–æ—Ç–∏–º
            list.innerHTML += `
                <div class="table-item" style="border-color: var(--secondary-color);">
                    <span>–°–¢–û–õ –° –ë–û–¢–ê–ú–ò (b1) | –ò–≥—Ä–æ–∫–æ–≤: 1-4</span>
                    <button class="main-button" onclick="joinTable('b1', true)" style="width: auto; padding: 5px 15px; font-size: 1em; background: #333; box-shadow:none;">–°–ï–°–¢–¨ –° –ë–û–¢–ê–ú–ò</button>
                </div>
            `;
        }
        
        socket.on('game_start', (data) => {
            currentTableId = data.tableId;
            showGame();
            updateDisplay('–ò–≥—Ä–∞ –Ω–∞—á–∞–ª–∞—Å—å! –°–¥–µ–ª–∞–π—Ç–µ –≤–∞—à—É —Å—Ç–∞–≤–∫—É.');
        });
        
        socket.on('table_state', (data) => {
            clearHands();
            const selfData = data.players.find(p => p.id === playerId);
            
            // –†–µ–Ω–¥–µ—Ä –î–∏–ª–µ—Ä–∞
            data.dealerHand.forEach((card, index) => {
                const isFaceDown = (data.state === 'WAITING_FOR_BETS' || data.state === 'DEALING') && index === 1;
                renderCard(card, 'dealerHand', !isFaceDown);
            });
            document.getElementById('dealerScore').textContent = data.dealerScore > 0 && data.state !== 'PLAYER_TURN' ? `(${data.dealerScore})` : '';

            // –†–µ–Ω–¥–µ—Ä –ò–≥—Ä–æ–∫–∞
            if (selfData) {
                selfData.hand.forEach(card => renderCard(card, 'playerHand', true));
                document.getElementById('playerScore').textContent = `(${selfData.score})`;
            }

            // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ UI
            document.getElementById('betControls').style.display = data.state === 'WAITING_FOR_BETS' && selfData && selfData.bet === 0 ? 'flex' : 'none';
            document.getElementById('actionButtons').style.display = data.state === 'PLAYER_TURN' && selfData && selfData.active && selfData.hand.length > 0 ? 'flex' : 'none';
            
            if (data.state === 'PLAYER_TURN' && selfData && selfData.active) updateDisplay(`–í–ê–® –•–û–î! –°—Ç–∞–≤–∫–∞: ${selfData.bet}`);
            else if (data.state === 'WAITING_FOR_BETS' && selfData && selfData.bet === 0) updateDisplay(`–°–¥–µ–ª–∞–π—Ç–µ —Å—Ç–∞–≤–∫—É.`);
            else if (data.state === 'WAITING_FOR_BETS' && selfData && selfData.bet > 0) updateDisplay(`–û–∂–∏–¥–∞–µ–º —Å—Ç–∞–≤–∫–∏ –æ—Ç –¥—Ä—É–≥–∏—Ö –∏–≥—Ä–æ–∫–æ–≤. –í–∞—à–∞ —Å—Ç–∞–≤–∫–∞: ${selfData.bet}`);
        });

        socket.on('game_results', (data) => {
            // ... –ª–æ–≥–∏–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –∏ –≤—ã–∏–≥—Ä—ã—à–∞ ...
        });

        socket.on('return_to_lobby', () => { showLobby(); });
        

        // --- –ö–õ–ò–ï–ù–¢–°–ö–ò–ï –ö–ù–û–ü–ö–ò ---
        function joinTable(tableId, wantsBots = false) { 
            socket.emit('join_table', { tableId: tableId, gameType: 'Blackjack', wantsBots: wantsBots }); 
        }
        
        document.getElementById('placeBetBtn').onclick = () => {
            const amount = parseInt(document.getElementById('betAmount').value);
            if (amount >= 10 && amount <= balance) { 
                socket.emit('place_bet', { tableId: currentTableId, amount: amount }); 
            } else {
                 alert('–ù–µ–≤–µ—Ä–Ω–∞—è —Å—É–º–º–∞ —Å—Ç–∞–≤–∫–∏.');
            }
        };
        document.getElementById('hitBtn').onclick = () => { socket.emit('hit', { tableId: currentTableId }); };
        document.getElementById('standBtn').onclick = () => { socket.emit('stand', { tableId: currentTableId }); };
        document.getElementById('leaveTableBtn').onclick = () => { if (confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã?")) { socket.emit('leave_table'); } };

        window.onload = () => { updateGlobalBalance(balance); };
    </script>
</body>
</html>