<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ö–∞–∑–∏–Ω–æ: –ë–ª—ç–∫–¥–∂–µ–∫ (–û–Ω–ª–∞–π–Ω)</title>
    <link rel="stylesheet" href="style.css">
    <script src="/socket.io/socket.io.js"></script>
</head>
<body>

<div class="casino-wrapper" id="casinoWrapper">
    <div class="game-container">
        <a href="index.html" id="backBtn" class="main-button" style="width: auto; padding: 5px 10px; font-size: 1em; align-self: flex-start; background: #555;">‚Üê –ù–∞–∑–∞–¥</a>
        
        <h1 style="color:var(--neon-blue); text-shadow: var(--shadow-blue);">üÉè –û–ù–õ–ê–ôN –ë–õ–≠–ö–î–ñ–ï–ö</h1>
        
        <div class="header-controls">
            <div class="display" id="balanceDisplay">–ë–∞–ª–∞–Ω—Å: 0</div>
        </div>
        
        <div class="display" id="messageDisplay" style="width: 90%; text-align: center; color: var(--neon-text);">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</div>

        <div id="lobbyView" style="width: 100%; display: flex; flex-direction: column; align-items: center; gap: 10px;">
            <div style="display: flex; gap: 10px; width: 100%; max-width: 400px; justify-content: center;">
                 <button class="main-button" id="quickPlayBtn" style="background: var(--neon-green);">üöÄ –ë—ã—Å—Ç—Ä–∞—è –ò–≥—Ä–∞</button>
            </div>
            <div style="display: flex; gap: 10px; width: 100%; max-width: 400px; justify-content: center;">
                <button class="main-button" id="createTableBtn">...–∏–ª–∏ –°–æ–∑–¥–∞—Ç—å –°–≤–æ–π –°—Ç–æ–ª</button>
            </div>
            <div id="createTableForm" class="form-panel" style="display: none; width: 100%; max-width: 400px;">
                 <h2>–°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç–æ–ª–∞</h2>
                 <label for="maxPlayersInput">–ú–∞–∫—Å. –∏–≥—Ä–æ–∫–æ–≤ (2-6):</label>
                 <input type="number" id="maxPlayersInput" min="2" max="6" value="4">
                 <label for="minBetInput">–ú–∏–Ω. —Å—Ç–∞–≤–∫–∞:</label>
                 <input type="number" id="minBetInput" min="10" value="10">
                 <button class="main-button" id="submitTableBtn">–°–æ–∑–¥–∞—Ç—å</button>
            </div>
            <h2>–î–æ—Å—Ç—É–ø–Ω—ã–µ —Å—Ç–æ–ª—ã:</h2>
            <div id="lobbyTables" class="table-list" style="width: 100%; max-width: 500px;">
                </div>
        </div>

        <div id="tableView" style="display: none; width: 100%; max-width: 600px; text-align: center;">
            
            <h2 id="tableTitle" style="display: none;">–°—Ç–æ–ª: T1 (–ë–ª—ç–∫–¥–∂–µ–∫)</h2>
            <button class="main-button" id="leaveTableBtn" style="background: var(--neon-red);">–ü–æ–∫–∏–Ω—É—Ç—å —Å—Ç–æ–ª</button>
            
            <div class="player-panel" style="border-color: var(--neon-pink); margin-top: 10px;">
                <div class="player-info">–î–∏–ª–µ—Ä (<span id="dealerScore">0</span>)</div>
                <div id="dealerHand" class="hand-container"></div>
            </div>

            <div id="playersContainer" style="margin-top: 15px; width: 100%;">
                </div>

            <div class="controls-panel">
                <div class="bet-controls" id="bettingGroup" style="display: none;">
                    <input type="number" id="betAmountInput" placeholder="–°—Ç–∞–≤–∫–∞" value="10" min="10" style="width: 100px;">
                    <button class="main-button" id="placeBetBtn">–°–¥–µ–ª–∞—Ç—å —Å—Ç–∞–≤–∫—É</button>
                    <button class="main-button" id="startGameBtn" style="background: var(--neon-green); display: none;">–ù–∞—á–∞—Ç—å –∏–≥—Ä—É</button>
                </div>
                <div class="game-actions" id="actionsGroup" style="display: none; margin-top: 10px;">
                    <button class="main-button" id="hitBtn" disabled>–í–∑—è—Ç—å –µ—â–µ (Hit)</button>
                    <button class="main-button" id="standBtn" disabled>–•–≤–∞—Ç–∏—Ç (Stand)</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const socket = io();
    let currentTableId = null;
    let balance = 0;
    let myPlayerId = null;
    let myUsername = '';

    // –≠–ª–µ–º–µ–Ω—Ç—ã
    const balanceDisplay = document.getElementById('balanceDisplay');
    const messageDisplay = document.getElementById('messageDisplay');
    const lobbyView = document.getElementById('lobbyView');
    const tableView = document.getElementById('tableView');
    const lobbyTables = document.getElementById('lobbyTables');
    const playersContainer = document.getElementById('playersContainer');
    const betAmountInput = document.getElementById('betAmountInput');
    const placeBetBtn = document.getElementById('placeBetBtn');
    const hitBtn = document.getElementById('hitBtn');
    const standBtn = document.getElementById('standBtn');
    const leaveTableBtn = document.getElementById('leaveTableBtn');
    const createTableBtn = document.getElementById('createTableBtn');
    const submitTableBtn = document.getElementById('submitTableBtn');
    const maxPlayersInput = document.getElementById('maxPlayersInput');
    const minBetInput = document.getElementById('minBetInput');
    const createTableForm = document.getElementById('createTableForm');
    const startGameBtn = document.getElementById('startGameBtn');
    const quickPlayBtn = document.getElementById('quickPlayBtn');
    const bettingGroup = document.getElementById('bettingGroup');
    const actionsGroup = document.getElementById('actionsGroup');


    // --- –£–¢–ò–õ–ò–¢–´ –ö–õ–ò–ï–ù–¢–ê ---
    function updateDisplay(msg) {
        if (msg) messageDisplay.textContent = msg;
        balanceDisplay.textContent = `–ë–∞–ª–∞–Ω—Å: ${balance}`;
    }
    
    function showLobby() {
        tableView.style.display = 'none';
        lobbyView.style.display = 'flex';
        // –°–±—Ä–æ—Å –∫–Ω–æ–ø–æ–∫ —Å—Ç–∞–≤–æ–∫
        placeBetBtn.disabled = false;
        placeBetBtn.textContent = '–°–¥–µ–ª–∞—Ç—å —Å—Ç–∞–≤–∫—É';
        startGameBtn.style.display = 'none';
        startGameBtn.disabled = true;
        hitBtn.disabled = true;
        standBtn.disabled = true;
    }

    function showTable() {
        lobbyView.style.display = 'none';
        tableView.style.display = 'flex';
        createTableForm.style.display = 'none';
    }

    function renderCard(cardStr) {
        if (!cardStr) return '<div class="card card-back">?</div>';
        const rank = cardStr.slice(0, -1);
        const suit = cardStr.slice(-1);
        const suitSymbol = suit === 'H' ? '‚ô•' : suit === 'D' ? '‚ô¶' : suit === 'C' ? '‚ô£' : '‚ô†';
        const color = (suit === 'H' || suit === 'D') ? 'card-suit-red' : 'card-suit-black';
        return `<div class="card ${color}">${rank}<br>${suitSymbol}</div>`;
    }
    
    // --- –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –°–û–ö–ï–¢–û–í ---
    
    socket.on('connect', () => {
        socket.emit('auth_request');
    });

    socket.on('auth_success', (data) => {
        myPlayerId = data.id;
        balance = data.balance;
        updateDisplay('–ü–æ–¥–∫–ª—é—á–µ–Ω–æ! –í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–æ–ª.');
        if (data.username) myUsername = data.username;
    });

    socket.on('table_list', (tables) => {
        renderTableList(tables.filter(t => t.gameType === 'Blackjack'));
    });

    function renderTableList(tables) {
        lobbyTables.innerHTML = '';
        tables.sort((a, b) => (a.isPrivate === b.isPrivate ? 0 : a.isPrivate ? 1 : -1));

        tables.forEach(table => {
            const playersCount = parseInt(table.currentPlayers) || 0; 
            const maxPlayers = parseInt(table.maxPlayers) || 0;
            const neededPlayers = Math.max(0, maxPlayers - playersCount); 

            let tableStatus;
            if (table.state === 'PLAYER_TURN' || table.state === 'DEALER_TURN' || table.state === 'RESULTS') {
                tableStatus = '–ò–≥—Ä–∞ –∏–¥–µ—Ç';
                if (playersCount === maxPlayers) tableStatus = '–ò–≥—Ä–∞ –∏–¥–µ—Ç (–ü–æ–ª–Ω—ã–π)';
            } else if (table.state === 'READY_TO_START') {
                tableStatus = '–ì–æ—Ç–æ–≤ –∫ —Å—Ç–∞—Ä—Ç—É (–ñ–¥–µ—Ç –ø–µ—Ä–≤–æ–≥–æ –∏–≥—Ä–æ–∫–∞)';
            } else if (table.state === 'WAITING_FOR_BETS') {
                tableStatus = '–û–∂–∏–¥–∞–Ω–∏–µ —Å—Ç–∞–≤–æ–∫';
            } else {
                tableStatus = `–û–∂–∏–¥–∞–Ω–∏–µ (–Ω—É–∂–Ω–æ ${neededPlayers} –∏–≥—Ä–æ–∫–∞)`;
            }
            const icon = 'üÉè';
            const lock = table.isPrivate ? ' üîí' : '';
            const html = `
                <div class="table-item" onclick="joinTable('${table.id}', ${table.isPrivate})">
                    ${icon} –°—Ç–æ–ª: ${table.id}${lock} (${playersCount}/${maxPlayers})
                    <br>–ú–∏–Ω. —Å—Ç–∞–≤–∫–∞: ${table.minBet} | –°—Ç–∞—Ç—É—Å: <strong>${tableStatus}</strong>
                </div>
            `;
            lobbyTables.innerHTML += html;
        });
    }

    socket.on('table_joined', (data) => {
        currentTableId = data.tableId;
        document.getElementById('tableTitle').textContent = `–°—Ç–æ–ª: ${data.tableId} (${data.gameType})`;
        betAmountInput.value = data.minBet;
        showTable();
        updateDisplay('–í—ã –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª–∏—Å—å –∫ —Å—Ç–æ–ª—É. –°–¥–µ–ª–∞–π—Ç–µ —Å—Ç–∞–≤–∫—É.');
    });

    socket.on('table_state', (tableState) => {
        let myPlayer = tableState.players.find(p => p.id === myPlayerId);

        // 1. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–∏–ª–µ—Ä–∞ (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
        const dealerHandElement = document.getElementById('dealerHand');
        const dealerScoreElement = document.getElementById('dealerScore');
        
        dealerHandElement.innerHTML = '';
        if (tableState.dealerHand.length > 0) {
            const isGameActive = tableState.state === 'PLAYER_TURN' || tableState.state === 'DEALER_TURN';
            dealerHandElement.innerHTML += renderCard(tableState.dealerHand[0]);
            
            if (tableState.dealerHand.length > 1) {
                 dealerHandElement.innerHTML += isGameActive ? renderCard(null) : renderCard(tableState.dealerHand[1]);
            }
            dealerScoreElement.textContent = isGameActive ? calculateScore([tableState.dealerHand[0]]) : tableState.dealerScore;
            
            if (tableState.state === 'RESULTS' || tableState.state === 'DEALER_TURN') {
                dealerHandElement.innerHTML = tableState.dealerHand.map(renderCard).join('');
                dealerScoreElement.textContent = tableState.dealerScore;
            }
        }
        

        // 2. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–≥—Ä–æ–∫–æ–≤ (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π, –∫—Ä–æ–º–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è score –∏–∑ tableState)
        playersContainer.innerHTML = '';
        tableState.players.forEach(player => {
            const isMe = player.id === myPlayerId;
            const isActive = player.id === tableState.activePlayerId;
            const border = isActive ? '3px solid var(--neon-pink)' : '1px solid var(--neon-metal)';
            const shadow = isActive ? 'var(--shadow-pink)' : 'none';
            const statusText = player.active === false && (tableState.state === 'PLAYER_TURN' || tableState.state === 'DEALER_TURN') ? ' (–ó–∞–∫–æ–Ω—á–∏–ª)' : '';
            
            const playerHtml = `
                <div class="player-panel" style="border: ${border}; box-shadow: ${shadow};">
                    <div class="player-info">
                        ${isMe ? '–í–´' : player.username} (${player.score || 0})${statusText}
                    </div>
                    <div class="hand-container">
                        ${player.hand.map(renderCard).join('')}
                    </div>
                    <div class="display" style="font-size: 0.9em; margin-top: 5px;">–°—Ç–∞–≤–∫–∞: ${player.bet}</div>
                </div>
            `;
            playersContainer.innerHTML += playerHtml;
        });
        
        // 3. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–∞–º–∏
        
        const isMyTurn = myPlayer && tableState.activePlayerId === myPlayerId;
        const isWaitingForBets = tableState.state === 'WAITING_FOR_BETS';
        const isReadyToStart = tableState.state === 'READY_TO_START';
        const isResults = tableState.state === 'RESULTS';
        
        // –ö–Ω–æ–ø–∫–∏ "–í–∑—è—Ç—å" –∏ "–•–≤–∞—Ç–∏—Ç"
        hitBtn.disabled = !isMyTurn;
        standBtn.disabled = !isMyTurn;
        
        // –ü–∞–Ω–µ–ª—å —Å—Ç–∞–≤–æ–∫ / –î–µ–π—Å—Ç–≤–∏—è
        bettingGroup.style.display = isWaitingForBets || isReadyToStart || isResults ? 'flex' : 'none';
        actionsGroup.style.display = tableState.state === 'PLAYER_TURN' ? 'flex' : 'none';

        // –ö–Ω–æ–ø–∫–∞ "–°–¥–µ–ª–∞—Ç—å —Å—Ç–∞–≤–∫—É"
        if (isWaitingForBets || isResults) {
            placeBetBtn.disabled = false;
            placeBetBtn.textContent = '–°–¥–µ–ª–∞—Ç—å —Å—Ç–∞–≤–∫—É';
        } else if (myPlayer && myPlayer.bet > 0) {
            placeBetBtn.disabled = true;
            placeBetBtn.textContent = `–°—Ç–∞–≤–∫–∞: ${myPlayer.bet}`;
        }
        
        // –ö–õ–Æ–ß–ï–í–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ö–Ω–æ–ø–∫–∞ "–ù–∞—á–∞—Ç—å –∏–≥—Ä—É"
        if (isReadyToStart) {
            startGameBtn.style.display = 'inline-block';
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, —è–≤–ª—è—é—Å—å –ª–∏ —è –ø–µ—Ä–≤—ã–º –∏–≥—Ä–æ–∫–æ–º (—Ç–æ–ª—å–∫–æ –æ–Ω –º–æ–∂–µ—Ç –Ω–∞–∂–∞—Ç—å)
            const isFirstPlayer = tableState.players.length > 0 && tableState.players[0].id === myPlayerId;
            
            // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É, –µ—Å–ª–∏ —è –Ω–µ –ø–µ—Ä–≤—ã–π –∏–≥—Ä–æ–∫
            startGameBtn.disabled = !isFirstPlayer; 
            
            if (isFirstPlayer) {
                updateDisplay('–í—Å–µ —Å—Ç–∞–≤–∫–∏ —Å–¥–µ–ª–∞–Ω—ã. –ù–∞–∂–º–∏—Ç–µ "–ù–∞—á–∞—Ç—å –∏–≥—Ä—É"! (–¢–æ–ª—å–∫–æ –≤—ã –º–æ–∂–µ—Ç–µ –Ω–∞—á–∞—Ç—å)');
            } else {
                updateDisplay('–í—Å–µ —Å—Ç–∞–≤–∫–∏ —Å–¥–µ–ª–∞–Ω—ã. –û–∂–∏–¥–∞–Ω–∏–µ, –ø–æ–∫–∞ –ø–µ—Ä–≤—ã–π –∏–≥—Ä–æ–∫ –Ω–∞—á–Ω–µ—Ç –∏–≥—Ä—É...');
            }
        } else {
            startGameBtn.style.display = 'none';
            startGameBtn.disabled = true;
        }
        
        // –°–æ–æ–±—â–µ–Ω–∏—è –æ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –∏–≥—Ä—ã
        if (tableState.state === 'PLAYER_TURN' && isMyTurn) {
            updateDisplay('–í–∞—à —Ö–æ–¥. Hit –∏–ª–∏ Stand.');
        } else if (tableState.state === 'PLAYER_TURN' && !isMyTurn) {
            updateDisplay(`–•–æ–¥ –∏–≥—Ä–æ–∫–∞: ${tableState.players.find(p => p.id === tableState.activePlayerId)?.username || '...'} `);
        } else if (tableState.state === 'DEALER_TURN') {
            updateDisplay('–•–æ–¥ –¥–∏–ª–µ—Ä–∞...');
        } else if (tableState.state === 'RESULTS') {
            updateDisplay('–†–∞—É–Ω–¥ –∑–∞–≤–µ—Ä—à–µ–Ω. –î–µ–ª–∞–π—Ç–µ –Ω–æ–≤—É—é —Å—Ç–∞–≤–∫—É.');
        }
    });
    
    // ... (–æ—Å—Ç–∞–ª—å–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–∫–µ—Ç–æ–≤ - game_result, return_to_lobby, error_message)
    socket.on('game_result', (data) => {
        const resultType = data.winnings > 0 ? '–í—ã–∏–≥—Ä—ã—à' : data.winnings < 0 ? '–ü—Ä–æ–∏–≥—Ä—ã—à' : '–ù–∏—á—å—è';
        const message = `${data.message} (${resultType}: ${Math.abs(data.winnings)})`;
        alert(message);
    });

    socket.on('return_to_lobby', () => {
        currentTableId = null;
        showLobby();
        updateDisplay('–í—ã –ø–æ–∫–∏–Ω—É–ª–∏ —Å—Ç–æ–ª. –í—ã–±–µ—Ä–∏—Ç–µ –Ω–æ–≤—ã–π.');
    });

    socket.on('error_message', (message) => {
         alert(message);
         if (placeBetBtn.disabled && placeBetBtn.textContent === '–û–∂–∏–¥–∞–Ω–∏–µ...') {
            placeBetBtn.disabled = false;
            placeBetBtn.textContent = '–°–¥–µ–ª–∞—Ç—å —Å—Ç–∞–≤–∫—É';
         }
    });


    // --- –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –ö–ù–û–ü–û–ö ---

    createTableBtn.onclick = () => {
        createTableForm.style.display = 'flex';
    };

    submitTableBtn.onclick = () => {
        const maxPlayers = parseInt(maxPlayersInput.value);
        const minBet = parseInt(minBetInput.value);
        const isPrivate = confirm("–°–¥–µ–ª–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É –ø—Ä–∏–≤–∞—Ç–Ω–æ–π (—Å –ø–∞—Ä–æ–ª–µ–º)?");
        let password = null;
        if (isPrivate) password = prompt("–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å (–∏–ª–∏ –æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º):");
        
        if (maxPlayers >= 2 && minBet >= 10) {
            socket.emit('create_table', { gameType: 'Blackjack', maxPlayers, minBet, isPrivate, password });
            createTableForm.style.display = 'none';
        } else {
             alert('–ù–µ–≤–µ—Ä–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–æ–º–Ω–∞—Ç—ã.');
        }
    };
    
    function joinTable(tableId, isPrivate) { 
        let password = null;
        if (isPrivate) {
            password = prompt("–≠—Ç–æ –ø—Ä–∏–≤–∞—Ç–Ω—ã–π —Å—Ç–æ–ª. –í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å:");
            if (password === null) return;
        }
        socket.emit('join_table', { 
            tableId: tableId, 
            wantsBots: true,
            password: password 
        }); 
    }
    
    placeBetBtn.onclick = () => {
        const amount = parseInt(betAmountInput.value);
        if (amount >= 10 && amount <= balance) { 
            placeBetBtn.disabled = true;
            placeBetBtn.textContent = '–û–∂–∏–¥–∞–Ω–∏–µ...';
            socket.emit('place_bet', { tableId: currentTableId, amount: amount }); 
        } else {
             alert('–ù–µ–≤–µ—Ä–Ω–∞—è —Å—É–º–º–∞ —Å—Ç–∞–≤–∫–∏ –∏–ª–∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤.');
        }
    };
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–ù–∞—á–∞—Ç—å –∏–≥—Ä—É"
    startGameBtn.onclick = () => {
        startGameBtn.disabled = true;
        socket.emit('start_game_command', { tableId: currentTableId });
    };

    hitBtn.onclick = () => { 
        hitBtn.disabled = true; 
        standBtn.disabled = true;
        socket.emit('hit', { tableId: currentTableId }); 
    };
    
    standBtn.onclick = () => { 
        hitBtn.disabled = true; 
        standBtn.disabled = true;
        socket.emit('stand', { tableId: currentTableId }); 
    };
    
    leaveTableBtn.onclick = () => { 
        if (confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø–æ–∫–∏–Ω—É—Ç—å —Å—Ç–æ–ª?")) { 
            socket.emit('leave_table');
        }
    };
    
    // (quickPlayBtn –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ–ø—É—â–µ–Ω)
    
</script>

</body>
</html>