<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ö–∞–∑–∏–Ω–æ: –ë–ª—ç–∫–¥–∂–µ–∫ (–û–Ω–ª–∞–π–Ω)</title>
    <!-- –ü–û–î–ö–õ–Æ–ß–ê–ï–ú –ù–û–í–´–ô –°–¢–ò–õ–¨ -->
    <link rel="stylesheet" href="style.css">
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Socket.io -->
    <script src="/socket.io/socket.io.js"></script>
</head>
<body>

<div class="casino-wrapper" id="casinoWrapper">
    <div class="game-container">
        <a href="index.html" class="main-button" style="width: auto; padding: 5px 10px; font-size: 1em; align-self: flex-start; background: #555;">‚Üê –ù–∞–∑–∞–¥</a>
        
        <h1 style="color:var(--neon-blue); text-shadow: var(--shadow-blue);">üÉè –û–ù–õ–ê–ôN –ë–õ–≠–ö–î–ñ–ï–ö</h1>
        
        <div class="header-controls">
            <div class="display" id="balanceDisplay">–ë–∞–ª–∞–Ω—Å: 0</div>
        </div>
        
        <div class="display" id="messageDisplay" style="width: 90%; text-align: center; color: var(--neon-text);">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</div>

        <!-- –õ–û–ë–ë–ò (–í—ã–±–æ—Ä –∫–æ–º–Ω–∞—Ç) -->
        <div id="lobbyView" style="width: 100%; display: flex; flex-direction: column; gap: 10px;">
            <h3 style="color:var(--neon-pink); margin: 5px 0;">–î–û–°–¢–£–ü–ù–´–ï –°–¢–û–õ–´</h3>
            <div id="tablesList" style="display:flex; flex-direction:column; gap:10px;">
                <!-- –ö–æ–º–Ω–∞—Ç—ã –±—É–¥—É—Ç –∑–¥–µ—Å—å -->
            </div>
            
            <!-- –ö–Ω–æ–ø–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–≤–æ–µ–π –∫–æ–º–Ω–∞—Ç—ã -->
            <button id="createRoomBtn" class="main-button" style="background: var(--neon-blue); box-shadow: var(--shadow-blue); margin-top: 10px;">–°–û–ó–î–ê–¢–¨ –°–í–û–Æ –ö–û–ú–ù–ê–¢–£</button>
        </div>

        <!-- –ò–ì–†–ê -->
        <div class="game-view" id="gameView" style="display: none; width: 100%;">
            <div class="hand-display">
                <p style="color:var(--neon-red);">–î–∏–ª–µ—Ä: (–°—á–µ—Ç: <span id="dealerScore">?</span>)</p>
                <div id="dealerHand" class="hand-container"></div>
            </div>
            <div class="hand-display">
                <p style="color:var(--neon-green);">–í—ã: (–°—á–µ—Ç: <span id="playerScore">?</span>)</p>
                <div id="playerHand" class="hand-container"></div>
            </div>
            
            <!-- –ö–æ–Ω—Ç—Ä–æ–ª—å –°—Ç–∞–≤–æ–∫ -->
            <div id="betControls" style="display: flex; gap: 10px; align-items: center; justify-content: center; width: 100%; margin: 15px 0;">
                <input type="number" id="betAmount" value="10" min="10" max="1000" class="bet-input">
                <button class="main-button" id="placeBetBtn" style="padding: 10px 15px; font-size: 1em; width: auto;">–ü–û–°–¢–ê–í–ò–¢–¨</button>
            </div>
            
            <!-- –ö–æ–Ω—Ç—Ä–æ–ª—å –ò–≥—Ä—ã -->
            <div id="actionButtons" style="display: none; gap: 10px; width: 100%;">
                <button class="main-button" id="blackjackHitButton" style="background: var(--neon-green); box-shadow: var(--shadow-green);" disabled>–í–ó–Ø–¢–¨ (Hit)</button>
                <button class="main-button" id="blackjackStandButton" style="background: var(--neon-red); box-shadow: var(--shadow-red);" disabled>–•–í–ê–¢–ò–¢ (Stand)</button>
            </div>
            
            <button id="leaveTableBtn" class="main-button" style="margin-top: 20px; background: #444; box-shadow: none; padding: 10px;">–í–´–ô–¢–ò –ò–ó –ö–û–ú–ù–ê–¢–´</button>
        </div>
    </div>
</div>

<script>
    // ====================================================================
    // --- –ö–õ–ò–ï–ù–¢–°–ö–ò–ô JAVASCRIPT (–ù–û–í–´–ô, –î–õ–Ø –û–ù–õ–ê–ô–ù–ê) ---
    // ====================================================================
    
    const socket = io();
    let balance = 1000;
    let playerId = null;
    let currentTableId = null;

    // --- DOM –≠–ª–µ–º–µ–Ω—Ç—ã ---
    const balanceDisplay = document.getElementById('balanceDisplay');
    const messageDisplay = document.getElementById('messageDisplay');
    const lobbyView = document.getElementById('lobbyView');
    const gameView = document.getElementById('gameView');
    const tablesList = document.getElementById('tablesList');
    const createRoomBtn = document.getElementById('createRoomBtn');
    
    const dealerHandEl = document.getElementById('dealerHand');
    const playerHandEl = document.getElementById('playerHand');
    const dealerScoreEl = document.getElementById('dealerScore');
    const playerScoreEl = document.getElementById('playerScore');
    
    const betControls = document.getElementById('betControls');
    const betAmountInput = document.getElementById('betAmount');
    const placeBetBtn = document.getElementById('placeBetBtn');
    
    const actionButtons = document.getElementById('actionButtons');
    const hitBtn = document.getElementById('blackjackHitButton');
    const standBtn = document.getElementById('blackjackStandButton');
    const leaveTableBtn = document.getElementById('leaveTableBtn');

    // --- –£—Ç–∏–ª–∏—Ç—ã UI ---
    
    function renderCard(cardData, isFaceDown = false) {
        const cardContainer = document.createElement('div');
        cardContainer.className = 'card-container';
        
        const rank = cardData.length > 1 ? cardData.slice(0, -1) : '?';
        const suit = cardData.length > 1 ? cardData.slice(-1) : '?';
        
        const suitsMap = { 'C': '‚ô£', 'D': '‚ô¶', 'H': '‚ô•', 'S': '‚ô†' };
        const isRed = suit === 'H' || suit === 'D';
        const suitSymbol = suitsMap[suit] || '?';
        
        if (isFaceDown) {
            cardContainer.innerHTML = `<div class="card card-back">CASINO</div>`;
        } else {
            cardContainer.innerHTML = `
                <div class="card ${isRed ? 'red-suit' : ''}">
                    <span style="align-self: flex-start; margin-left: 3px; font-size: 0.8em;">${rank}</span>
                    <span class="card-suit-symbol">${suitSymbol}</span>
                    <span style="align-self: flex-end; margin-right: 3px; font-size: 0.8em; transform:rotate(180deg);">${rank}</span>
                </div>
            `;
        }
        return cardContainer;
    }

    function updateGlobalBalance(newBalance) {
        balance = newBalance;
        balanceDisplay.textContent = `–ë–∞–ª–∞–Ω—Å: ${balance}`;
        betAmountInput.max = balance;
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage –¥–ª—è –¥—Ä—É–≥–∏—Ö —Å—Ç—Ä–∞–Ω–∏—Ü
        localStorage.setItem('casinoBalance', balance);
    }

    function showLobby() {
        lobbyView.style.display = 'flex';
        gameView.style.display = 'none';
        currentTableId = null;
        messageDisplay.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–æ–ª –¥–ª—è –∏–≥—Ä—ã.';
    }

    function showGame(tableId) {
        lobbyView.style.display = 'none';
        gameView.style.display = 'flex';
        currentTableId = tableId;
        messageDisplay.textContent = `–í—ã –∑–∞ —Å—Ç–æ–ª–æ–º ${tableId}. –û–∂–∏–¥–∞–µ–º –Ω–∞—á–∞–ª–∞...`;
    }

    // --- SOCKET.IO –°–õ–£–®–ê–¢–ï–õ–ò ---
    
    socket.on('connect', () => {
        messageDisplay.textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω–æ. –ó–∞–ø—Ä–æ—Å –¥–∞–Ω–Ω—ã—Ö...';
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –±–∞–ª–∞–Ω—Å –∏–∑ localStorage, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
        balance = parseInt(localStorage.getItem('casinoBalance')) || 1000;
        socket.emit('auth_request'); 
    });
    
    socket.on('auth_success', (data) => {
        playerId = data.id;
        updateGlobalBalance(data.balance);
        if (!currentTableId) {
            renderTableList(data.tables);
            showLobby();
        }
    });
    
    socket.on('update_table_list', (tables) => {
        if (!currentTableId) { // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–±–±–∏, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –º—ã –≤ –Ω–µ–º
            renderTableList(tables);
        }
    });

    function renderTableList(tables) {
        tablesList.innerHTML = '';
        tables.filter(t => t.gameType === 'Blackjack').forEach(table => {
            const item = document.createElement('div');
            item.className = 'table-item';
            const statusColor = table.currentPlayers >= table.maxPlayers ? 'var(--neon-red)' : 'var(--neon-green)';
            
            item.innerHTML = `
                <div style="text-align: left;">
                    <span style="color:var(--neon-blue);">${table.name} (ID: ${table.id})</span><br>
                    <span style="font-size: 0.9em;">–ú–∏–Ω. —Å—Ç–∞–≤–∫–∞: ${table.minBet} | 
                    <span style="color:${statusColor};">–ò–≥—Ä–æ–∫–æ–≤: ${table.currentPlayers}/${table.maxPlayers}</span></span>
                </div>
                <button class="main-button" onclick="joinTable('${table.id}', ${table.id === 'b1'})" 
                        style="width: auto; padding: 5px 15px; font-size: 1em;"
                        ${table.currentPlayers >= table.maxPlayers ? 'disabled' : ''}>
                    –°–ï–°–¢–¨
                </button>
            `;
            tablesList.appendChild(item);
        });
    }
    
    socket.on('game_start', (data) => {
        showGame(data.tableId);
    });
    
    // –ì–õ–ê–í–ù–´–ô –û–ë–ù–û–í–ò–¢–ï–õ–¨ –°–¢–û–õ–ê
    socket.on('table_state', (data) => {
        if (!currentTableId) return; // –ï—Å–ª–∏ –º—ã –Ω–µ –∑–∞ —Å—Ç–æ–ª–æ–º, –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º
        
        dealerHandEl.innerHTML = '';
        playerHandEl.innerHTML = '';
        
        // –†–µ–Ω–¥–µ—Ä –î–∏–ª–µ—Ä–∞
        data.dealerHand.forEach((cardRank, index) => {
            const isFaceDown = (cardRank === 'BACK');
            dealerHandEl.appendChild(renderCard(cardRank, isFaceDown));
        });
        dealerScoreEl.textContent = `(${data.dealerScore})`;

        // –†–µ–Ω–¥–µ—Ä –ò–≥—Ä–æ–∫–æ–≤ (–∏—â–µ–º —Å–µ–±—è)
        const selfData = data.players.find(p => p.id === playerId);
        if (selfData) {
            selfData.hand.forEach(cardRank => {
                playerHandEl.appendChild(renderCard(cardRank, false));
            });
            playerScoreEl.textContent = `(${selfData.score})`;
            
            // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ UI
            if (data.state === 'WAITING_FOR_BETS' && selfData.bet === 0) {
                betControls.style.display = 'flex';
                actionButtons.style.display = 'none';
                messageDisplay.textContent = '–°–¥–µ–ª–∞–π—Ç–µ –≤–∞—à—É —Å—Ç–∞–≤–∫—É.';
            } else if (data.state === 'PLAYER_TURN' && selfData.active) {
                betControls.style.display = 'none';
                actionButtons.style.display = 'flex';
                hitBtn.disabled = false;
                standBtn.disabled = false;
                messageDisplay.textContent = '–í–ê–® –•–û–î!';
            } else {
                betControls.style.display = 'none';
                actionButtons.style.display = 'none';
                hitBtn.disabled = true;
                standBtn.disabled = true;
                if (data.state === 'WAITING_FOR_BETS') {
                     messageDisplay.textContent = `–û–∂–∏–¥–∞–µ–º —Å—Ç–∞–≤–∫–∏... (–í–∞—à–∞: ${selfData.bet})`;
                } else {
                     messageDisplay.textContent = '–û–∂–∏–¥–∞–µ–º —Ö–æ–¥–∞ –¥—Ä—É–≥–∏—Ö –∏–≥—Ä–æ–∫–æ–≤...';
                }
            }
        }
    });

    socket.on('game_results', (data) => {
        const result = data.results[playerId];
        if (result) {
            updateGlobalBalance(result.newBalance);
            messageDisplay.innerHTML = `<strong>${result.message}</strong><br>–û–∂–∏–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Ä–∞—É–Ω–¥–∞...`;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–µ –∫–∞—Ä—Ç—ã –¥–∏–ª–µ—Ä–∞
            dealerHandEl.innerHTML = '';
            data.dealerHand.forEach(card => dealerHandEl.appendChild(renderCard(card, false)));
            dealerScoreEl.textContent = `(${data.dealerScore})`;
        }
    });
    
    // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ö–ù–û–ü–ö–ò –í–´–•–û–î–ê
    socket.on('return_to_lobby', (data) => {
        currentTableId = null;
        renderTableList(data.tables); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —Å—Ç–æ–ª–æ–≤
        showLobby();
        messageDisplay.textContent = '–í—ã –≤—ã—à–ª–∏ –∏–∑-–∑–∞ —Å—Ç–æ–ª–∞.';
    });

    socket.on('error_message', (msg) => {
        messageDisplay.textContent = `‚ùå –û—à–∏–±–∫–∞: ${msg}`;
    });
    
    socket.on('bet_accepted', (data) => {
        updateGlobalBalance(data.newBalance);
    });

    // --- –ö–õ–ò–ï–ù–¢–°–ö–ò–ï –ö–ù–û–ü–ö–ò ---
    
    function joinTable(tableId, wantsBots = false) { 
        socket.emit('join_table', { tableId: tableId, wantsBots: wantsBots }); 
    }
    
    createRoomBtn.onclick = () => {
        const maxPlayers = parseInt(prompt("–ú–∞–∫—Å. –∏–≥—Ä–æ–∫–æ–≤ (2-5):", "4"));
        const minBet = parseInt(prompt("–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—Ç–∞–≤–∫–∞:", "25"));
        const isPrivate = confirm("–°–¥–µ–ª–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É –ø—Ä–∏–≤–∞—Ç–Ω–æ–π (—Å –ø–∞—Ä–æ–ª–µ–º)?");
        let password = null;
        if (isPrivate) password = prompt("–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å:");
        
        if (maxPlayers >= 2 && minBet >= 1) {
            socket.emit('create_table', { maxPlayers, minBet, isPrivate, password });
        }
    };
    
    placeBetBtn.onclick = () => {
        const amount = parseInt(betAmountInput.value);
        if (amount >= 10 && amount <= balance) { 
            socket.emit('place_bet', { tableId: currentTableId, amount: amount }); 
        } else {
             alert('–ù–µ–≤–µ—Ä–Ω–∞—è —Å—É–º–º–∞ —Å—Ç–∞–≤–∫–∏.');
        }
    };
    
    hitBtn.onclick = () => { 
        hitBtn.disabled = true; 
        standBtn.disabled = true;
        socket.emit('hit', { tableId: currentTableId }); 
    };
    
    standBtn.onclick = () => { 
        hitBtn.disabled = true; 
        standBtn.disabled = true;
        socket.emit('stand', { tableId: currentTableId }); 
    };
    
    leaveTableBtn.onclick = () => { 
        if (confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø–æ–∫–∏–Ω—É—Ç—å —Å—Ç–æ–ª?")) { 
            socket.emit('leave_table'); 
        } 
    };

    // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ---
    window.onload = () => {
        // –ó–∞–≥—Ä—É–∑–∫–∞ –±–∞–ª–∞–Ω—Å–∞ –∏–∑ localStorage
        const storedBalance = localStorage.getItem('casinoBalance');
        if (storedBalance) {
            balance = parseInt(storedBalance);
        }
        updateGlobalBalance(balance);
        showLobby(); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–æ–±–±–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    };
</script>
</body>
</html>