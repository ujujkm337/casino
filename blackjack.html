<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ö–∞–∑–∏–Ω–æ: –ë–ª—ç–∫–¥–∂–µ–∫ (–û–Ω–ª–∞–π–Ω)</title>
    <link rel="stylesheet" href="style.css">
    <script src="/socket.io/socket.io.js"></script>
</head>
<body>

<div class="casino-wrapper" id="casinoWrapper">
    <div class="game-container">
        <a href="index.html" class="main-button" style="width: auto; padding: 5px 10px; font-size: 1em; align-self: flex-start; background: #555;">‚Üê –ù–∞–∑–∞–¥</a>
        
        <h1 style="color:var(--neon-blue); text-shadow: var(--shadow-blue);">üÉè –û–ù–õ–ê–ôN –ë–õ–≠–ö–î–ñ–ï–ö</h1>
        
        <div class="header-controls">
            <div class="display" id="balanceDisplay">–ë–∞–ª–∞–Ω—Å: 0</div>
        </div>
        
        <div class="display" id="messageDisplay" style="width: 90%; text-align: center; color: var(--neon-text);">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</div>

        <div id="lobbyView" style="width: 100%; display: flex; flex-direction: column; align-items: center; gap: 10px;">
            <div style="display: flex; gap: 10px; width: 100%;">
                <button id="createTableBtn" class="action-button main-button" style="width: 50%;">–°–æ–∑–¥–∞—Ç—å –°—Ç–æ–ª</button>
                <button onclick="socket.emit('auth_request')" class="action-button" style="width: 50%;">–û–±–Ω–æ–≤–∏—Ç—å</button>
            </div>
            <div id="tableList" class="table-list">
                <div class="table-item">–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–æ–ª–æ–≤...</div>
            </div>
        </div>

        <div id="tableView" style="width: 100%; display: none; flex-direction: column; align-items: center; gap: 10px;">
            <button id="leaveTableBtn" class="action-button" style="background: var(--neon-red); box-shadow: var(--shadow-red);">–ü–æ–∫–∏–Ω—É—Ç—å –°—Ç–æ–ª</button>
            
            <div id="tableInfo" class="display" style="width: 90%; margin-bottom: 15px;">
                </div>

            <div id="playerSlots" style="width: 100%; display: flex; flex-direction: column; gap: 10px;">
                </div>
            
            <div class="player-slot dealer-slot">
                <div class="player-info" style="color: var(--neon-red);">–î–ò–õ–ï–† <span id="dealerScore">0</span></div>
                <div class="hand-container" id="dealerHand"></div>
            </div>

            <div id="gameControls" style="display: none; width: 100%;">
                
                <button id="startGameBtn" class="action-button main-button" style="background: var(--neon-green); box-shadow: var(--shadow-green); margin-bottom: 10px; display: none;">–ù–ê–ß–ê–¢–¨ –ò–ì–†–£</button>
                
                <div style="display: flex; justify-content: center; align-items: center; gap: 10px;">
                    <input type="number" id="betAmountInput" value="100" min="10" step="10" class="input-field" style="width: 100px;">
                    <button id="placeBetBtn" class="action-button main-button">–°–¥–µ–ª–∞—Ç—å –°—Ç–∞–≤–∫—É</button>
                </div>
                
                <div id="gameActionButtons" style="display: flex; justify-content: center; gap: 10px; margin-top: 10px;">
                    <button id="hitBtn" class="action-button" disabled>–í–∑—è—Ç—å –∫–∞—Ä—Ç—É</button>
                    <button id="standBtn" class="action-button" disabled>–•–≤–∞—Ç–∏—Ç</button>
                </div>
            </div>
            
        </div>
    </div>
</div>

<script>
    const socket = io();
    let myId = null;
    let balance = 0;
    let currentTableId = null;

    // --- DOM –≠–ª–µ–º–µ–Ω—Ç—ã ---
    const balanceDisplay = document.getElementById('balanceDisplay');
    const lobbyView = document.getElementById('lobbyView');
    const tableView = document.getElementById('tableView');
    const messageDisplay = document.getElementById('messageDisplay');
    const placeBetBtn = document.getElementById('placeBetBtn');
    const hitBtn = document.getElementById('hitBtn');
    const standBtn = document.getElementById('standBtn');
    const leaveTableBtn = document.getElementById('leaveTableBtn');
    const createTableBtn = document.getElementById('createTableBtn');
    const betAmountInput = document.getElementById('betAmountInput');
    const gameControls = document.getElementById('gameControls');
    
    // NEW: –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–Ω—Å—Ç–∞–Ω—Ç—É –¥–ª—è –∫–Ω–æ–ø–∫–∏ —Å—Ç–∞—Ä—Ç–∞
    const startGameBtn = document.getElementById('startGameBtn');

    // --- –£–¢–ò–õ–ò–¢–´ ---
    function updateDisplay(msg = null) {
        balanceDisplay.textContent = `–ë–∞–ª–∞–Ω—Å: ${balance}`;
        if (msg) messageDisplay.textContent = msg;
    }
    
    function showLobby() {
        lobbyView.style.display = 'flex';
        tableView.style.display = 'none';
    }

    // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –∫–∞—Ä—Ç—ã (—É–ø—Ä–æ—â–µ–Ω–Ω–æ)
    function renderCard(cardStr) {
        if (!cardStr) return '<div class="card card-back">?</div>';
        const rank = cardStr.slice(0, -1);
        const suit = cardStr.slice(-1);
        let suitSymbol = '';
        let colorClass = '';
        
        if (suit === 'H') { suitSymbol = '‚ô•'; colorClass = 'red-suit'; }
        else if (suit === 'D') { suitSymbol = '‚ô¶'; colorClass = 'red-suit'; }
        else if (suit === 'C') { suitSymbol = '‚ô£'; colorClass = 'black-suit'; }
        else if (suit === 'S') { suitSymbol = '‚ô†'; colorClass = 'black-suit'; }
        
        return `<div class="card ${colorClass}">
            <span class="card-rank">${rank}</span>
            <span class="card-suit">${suitSymbol}</span>
        </div>`;
    }

    // --- SOCKET.IO –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò ---

    socket.on('connect', () => {
        messageDisplay.textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —Å–µ—Ä–≤–µ—Ä—É. –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è...';
        socket.emit('auth_request');
    });

    socket.on('auth_success', (data) => {
        myId = data.id;
        balance = data.balance;
        updateDisplay('–£—Å–ø–µ—à–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è.');
    });

    // FIX/UPDATE: renderTableList - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –æ—à–∏–±–∫–∞ NaN –∏ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ minPlayers
    socket.on('table_list', (tables) => {
        renderTableList(tables);
    });
    
    function renderTableList(tables) {
        const tableList = document.getElementById('tableList');
        tableList.innerHTML = '';
        
        tables.forEach(table => {
            const el = document.createElement('div');
            el.className = 'table-item';
            
            let statusText = '';
            const currentCount = table.currentPlayers;
            const requiredPlayers = table.minPlayers; // –ò—Å–ø–æ–ª—å–∑—É–µ–º minPlayers
            
            if (table.state === 'WAITING_FOR_PLAYERS') {
                if (currentCount < requiredPlayers) {
                    statusText = `–û–∂–∏–¥–∞–Ω–∏–µ (${requiredPlayers - currentCount} –¥–æ —Å—Ç–∞—Ä—Ç–∞)`;
                } else {
                    statusText = `–ì–æ—Ç–æ–≤ –∫ —Å—Ç–∞—Ä—Ç—É (–º–∏–Ω. ${requiredPlayers} –Ω–∞–±—Ä–∞–Ω–æ)`;
                }
            } else if (table.state === 'BETTING_ROUND') {
                 statusText = '–ò–¥–µ—Ç —Ä–∞—É–Ω–¥ —Å—Ç–∞–≤–æ–∫ ‚è≥';
            } else {
                 statusText = '–ò–ì–†–ê –ò–î–ï–¢ üÉè';
            }
            
            el.innerHTML = `
                <strong>–°—Ç–æ–ª: ${table.id} (${table.currentPlayers}/${table.maxPlayers})</strong>
                <br>–ò–≥—Ä–∞: Blackjack | –ú–∏–Ω. —Å—Ç–∞–≤–∫–∞: ${table.minBet}
                <br>–ú–∏–Ω. –∏–≥—Ä–æ–∫–æ–≤: ${table.minPlayers}
                <br>${table.isPrivate ? 'üîí –ü—Ä–∏–≤–∞—Ç–Ω—ã–π' : 'üåê –ü—É–±–ª–∏—á–Ω—ã–π'}
                <br><em>${statusText}</em>
                <button class="action-button" onclick="joinTable('${table.id}', ${table.isPrivate})">–í–æ–π—Ç–∏</button>
            `;
            tableList.appendChild(el);
        });
    }

    socket.on('table_joined', (data) => {
        currentTableId = data.tableId;
        messageDisplay.textContent = `–í—ã –≤–æ—à–ª–∏ –∑–∞ —Å—Ç–æ–ª ${currentTableId}.`;
    });

    // UPDATE: renderTableView - –î–æ–±–∞–≤–ª–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ –∫–Ω–æ–ø–∫–∏ "–ù–∞—á–∞—Ç—å –∏–≥—Ä—É"
    socket.on('table_state', (tableState) => {
        renderTableView(tableState, myId);
    });

    function renderTableView(tableState, myId) {
        document.getElementById('lobbyView').style.display = 'none';
        document.getElementById('tableView').style.display = 'flex';
        gameControls.style.display = 'flex';
        currentTableId = tableState.id;
        
        const tableInfo = document.getElementById('tableInfo');
        const playerSlots = document.getElementById('playerSlots');
        const dealerHandEl = document.getElementById('dealerHand');

        dealerHandEl.innerHTML = tableState.dealerHand.map(renderCard).join('');
        document.getElementById('dealerScore').textContent = tableState.dealerScore > 0 ? `(${tableState.dealerScore})` : '';

        tableInfo.innerHTML = `
            <strong>–°–¢–û–õ: ${tableState.id} (${tableState.state})</strong> 
            –ú–∏–Ω. —Å—Ç–∞–≤–∫–∞: ${tableState.minBet} | 
            –ò–≥—Ä–æ–∫–æ–≤: ${tableState.players.length}/${tableState.maxPlayers}
        `;

        // --- –õ–û–ì–ò–ö–ê –ö–ù–û–ü–ö–ò "–ù–ê–ß–ê–¢–¨ –ò–ì–†–£" ---
        const playerCount = tableState.players.length;
        
        if (myId === tableState.creatorId && tableState.state === 'WAITING_FOR_PLAYERS') {
            startGameBtn.style.display = 'block';
            
            // –ö–Ω–æ–ø–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–∞–±—Ä–∞–Ω–æ –º–∏–Ω. 2 –∏–≥—Ä–æ–∫–∞
            startGameBtn.disabled = playerCount < tableState.minPlayers; 
            
            if (startGameBtn.disabled) {
                startGameBtn.textContent = `–ú–∏–Ω. ${tableState.minPlayers} –∏–≥—Ä–æ–∫–∞ (${tableState.minPlayers - playerCount} –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç)`;
                messageDisplay.textContent = '–ñ–¥–µ–º –¥—Ä—É–≥–∏—Ö –∏–≥—Ä–æ–∫–æ–≤...';
            } else {
                startGameBtn.textContent = '–ù–ê–ß–ê–¢–¨ –ò–ì–†–£ üöÄ';
                messageDisplay.textContent = '–í—ã ‚Äî —Å–æ–∑–¥–∞—Ç–µ–ª—å. –ù–∞–∂–º–∏—Ç–µ "–ù–∞—á–∞—Ç—å –∏–≥—Ä—É".';
            }
            
            // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –∏–≥—Ä—ã/—Å—Ç–∞–≤–æ–∫ –≤ —Ä–µ–∂–∏–º–µ –æ–∂–∏–¥–∞–Ω–∏—è
            placeBetBtn.style.display = 'none';
            document.getElementById('gameActionButtons').style.display = 'none';

        } else if (tableState.state === 'BETTING_ROUND') {
            startGameBtn.style.display = 'none'; // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —Å—Ç–∞—Ä—Ç–∞
            placeBetBtn.style.display = 'block'; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —Å—Ç–∞–≤–∫–∏
            document.getElementById('gameActionButtons').style.display = 'none';
            messageDisplay.textContent = '–†–ê–£–ù–î –°–¢–ê–í–û–ö! –°–¥–µ–ª–∞–π—Ç–µ —Å—Ç–∞–≤–∫—É.';
            
            // –õ–æ–≥–∏–∫–∞, –µ—Å–ª–∏ –∏–≥—Ä–æ–∫ —É–∂–µ —Å–¥–µ–ª–∞–ª —Å—Ç–∞–≤–∫—É
            const me = tableState.players.find(p => p.id === myId);
            if (me && me.bet > 0) {
                 placeBetBtn.disabled = true;
                 placeBetBtn.textContent = `–°—Ç–∞–≤–∫–∞ –ø—Ä–∏–Ω—è—Ç–∞: ${me.bet}`;
                 messageDisplay.textContent = '–í–∞—à–∞ —Å—Ç–∞–≤–∫–∞ –ø—Ä–∏–Ω—è—Ç–∞. –û–∂–∏–¥–∞–µ–º –¥—Ä—É–≥–∏—Ö –∏–≥—Ä–æ–∫–æ–≤...';
            } else {
                 placeBetBtn.disabled = false;
                 placeBetBtn.textContent = '–°–¥–µ–ª–∞—Ç—å –°—Ç–∞–≤–∫—É';
            }

        } else {
            // –í –¥—Ä—É–≥–∏—Ö —Å–æ—Å—Ç–æ—è–Ω–∏—è—Ö (PLAYER_TURN, DEALER_TURN, RESULTS)
            startGameBtn.style.display = 'none';
            placeBetBtn.style.display = 'none';
            document.getElementById('gameActionButtons').style.display = 'flex'; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º Hit/Stand
            
            // ... –ó–¥–µ—Å—å –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ª–æ–≥–∏–∫–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ hit/stand

        }
        
        // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Å–ª–æ—Ç–æ–≤ –∏–≥—Ä–æ–∫–æ–≤
        playerSlots.innerHTML = tableState.players.map(p => {
            let info = `${p.username}`;
            if (p.id === myId) info += ' (–í—ã)';
            if (p.id === tableState.creatorId) info += ' ‚≠ê';
            
            let scoreText = p.score > 0 ? `(${p.score})` : '';
            if (p.bet > 0) info += ` | –°—Ç–∞–≤–∫–∞: ${p.bet}`;
            
            return `
                <div class="player-slot ${p.id === myId ? 'current-player' : ''}">
                    <div class="player-info">${info} ${scoreText}</div>
                    <div class="hand-container">${p.hand.map(renderCard).join('') || '–ù–µ—Ç –∫–∞—Ä—Ç'}</div>
                </div>
            `;
        }).join('');
    }

    socket.on('player_left', (data) => {
        updateDisplay(`–ò–≥—Ä–æ–∫ ${data.playerId} –ø–æ–∫–∏–Ω—É–ª —Å—Ç–æ–ª.`);
    });
    
    socket.on('return_to_lobby', (data) => {
        currentTableId = null;
        renderTableList(data.tables);
        showLobby();
        messageDisplay.textContent = '–í—ã –≤—ã—à–ª–∏ –∏–∑-–∑–∞ —Å—Ç–æ–ª–∞.';
        gameControls.style.display = 'none';
    });

    socket.on('error_message', (msg) => {
        messageDisplay.textContent = `‚ùå –û—à–∏–±–∫–∞: ${msg}`;
        hitBtn.disabled = false; 
        standBtn.disabled = false;
    });

    // --- –ö–õ–ò–ï–ù–¢–°–ö–ò–ï –ö–ù–û–ü–ö–ò ---
    
    function joinTable(tableId, isPrivate) { 
        if (isPrivate) {
            const password = prompt("–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –¥–ª—è –ø—Ä–∏–≤–∞—Ç–Ω–æ–≥–æ —Å—Ç–æ–ª–∞:");
            socket.emit('join_table', { tableId: tableId, password: password }); 
        } else {
            socket.emit('join_table', { tableId: tableId }); 
        }
    }
    
    createTableBtn.onclick = () => {
        const maxPlayers = parseInt(prompt("–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–≥—Ä–æ–∫–æ–≤ (2-6):") || 6);
        const minBet = parseInt(prompt("–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—Ç–∞–≤–∫–∞ (–º–∏–Ω–∏–º—É–º 10):") || 10);
        const isPrivate = confirm("–°–¥–µ–ª–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É –ø—Ä–∏–≤–∞—Ç–Ω–æ–π?");
        let password = null;
        if (isPrivate) password = prompt("–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å:");
        
        if (maxPlayers >= 2 && maxPlayers <= 6 && minBet >= 1) {
            socket.emit('create_table', { maxPlayers, minBet, isPrivate, password });
        } else {
            alert('–ù–µ–≤–µ—Ä–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Å–æ–∑–¥–∞–Ω–∏—è —Å—Ç–æ–ª–∞.');
        }
    };
    
    // NEW: –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–ù–∞—á–∞—Ç—å –∏–≥—Ä—É"
    startGameBtn.onclick = () => { 
        if (confirm("–ù–∞—á–∞—Ç—å –∏–≥—Ä—É –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ (–∑–∞–ø—É—Å—Ç–∏—Ç—å —Ä–∞—É–Ω–¥ —Å—Ç–∞–≤–æ–∫)?")) { 
            socket.emit('start_game', { tableId: currentTableId }); 
        } 
    };

    placeBetBtn.onclick = () => {
        const amount = parseInt(betAmountInput.value);
        if (amount >= 10 && amount <= balance) { 
            placeBetBtn.disabled = true;
            placeBetBtn.textContent = '–û–∂–∏–¥–∞–Ω–∏–µ...';
            socket.emit('place_bet', { tableId: currentTableId, amount: amount }); 
        } else {
             alert('–ù–µ–≤–µ—Ä–Ω–∞—è —Å—É–º–º–∞ —Å—Ç–∞–≤–∫–∏ –∏–ª–∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤.');
        }
    };
    
    hitBtn.onclick = () => { 
        hitBtn.disabled = true; 
        standBtn.disabled = true;
        socket.emit('hit', { tableId: currentTableId }); 
    };
    
    standBtn.onclick = () => { 
        hitBtn.disabled = true; 
        standBtn.disabled = true;
        socket.emit('stand', { tableId: currentTableId }); 
    };
    
    leaveTableBtn.onclick = () => { 
        if (confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø–æ–∫–∏–Ω—É—Ç—å —Å—Ç–æ–ª?")) { 
            socket.emit('leave_table'); 
        } 
    };

    // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ---
    window.onload = () => {
        socket.emit('auth_request');
    };
</script>

</body>
</html>