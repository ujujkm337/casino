<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ö–∞–∑–∏–Ω–æ: –ë–ª—ç–∫–¥–∂–µ–∫ (–û–Ω–ª–∞–π–Ω)</title>
    <link rel="stylesheet" href="style.css">
    <script src="/socket.io/socket.io.js"></script>
</head>
<body>

<div class="casino-wrapper" id="casinoWrapper">
    <div class="game-container">
        <a href="index.html" class="main-button" style="width: auto; padding: 5px 10px; font-size: 1em; align-self: flex-start; background: #555;">‚Üê –ù–∞–∑–∞–¥</a>
        
        <h1 style="color:var(--neon-blue); text-shadow: var(--shadow-blue);">üÉè –û–ù–õ–ê–ô–ù –ë–õ–≠–ö–î–ñ–ï–ö</h1>
        
        <div class="header-controls">
            <div class="display" id="balanceDisplay">–ë–∞–ª–∞–Ω—Å: 0</div>
        </div>
        
        <div class="display" id="messageDisplay" style="width: 90%; text-align: center; color: var(--neon-text);">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</div>

        <div id="lobbyView" style="width: 100%; display: flex; flex-direction: column; align-items: center; gap: 10px;">
            <div id="tableList" class="table-list" style="width: 100%; max-width: 400px; display: flex; flex-direction: column; gap: 5px;">
                </div>
            
            <button id="createTableBtn" class="main-button" style="background-color: var(--neon-green); box-shadow: var(--shadow-green);">–°–æ–∑–¥–∞—Ç—å —Å–≤–æ—é –∫–æ–º–Ω–∞—Ç—É</button>
            
            <div id="createTableForm" style="display: none; width: 100%; max-width: 400px; padding: 10px; background: var(--neon-metal); border-radius: 5px;">
                <label>–ú–∞–∫—Å. –∏–≥—Ä–æ–∫–æ–≤: <input type="number" id="maxPlayersInput" value="4" min="2" max="6"></label><br>
                <label>–ú–∏–Ω. —Å—Ç–∞–≤–∫–∞: <input type="number" id="minBetInput" value="10" min="1"></label><br>
                <button id="submitCreateTableBtn" class="main-button">–°–æ–∑–¥–∞—Ç—å</button>
            </div>
        </div>

        <div id="tableView" style="display: none; width: 100%; max-width: 600px; padding: 10px; border: 1px solid var(--neon-blue); border-radius: 10px;">
            
            <h2 id="tableName" style="text-align: center; color: var(--neon-blue); font-size: 1.5em;">–°—Ç–æ–ª: </h2>
            
            <div id="dealerContainer" class="player-area" style="margin-bottom: 20px;">
                <h3 style="color: var(--neon-red);">–î–∏–ª–µ—Ä (<span id="dealerScore">?</span>)</h3>
                <div id="dealerHand" class="hand-container"></div>
            </div>

            <div id="playersContainer" style="margin-bottom: 20px; display: flex; flex-wrap: wrap; justify-content: center; gap: 10px;">
                </div>
            
            <div id="playerControls" style="display: none; flex-direction: column; gap: 10px;">
                <div id="betControls" style="display: flex; gap: 10px; justify-content: center;">
                    <input type="number" id="betAmountInput" value="10" min="10" style="width: 80px; text-align: center;">
                    <button id="placeBetBtn" class="main-button" style="background-color: var(--neon-green);">–°–¥–µ–ª–∞—Ç—å —Å—Ç–∞–≤–∫—É</button>
                </div>
                <div id="gameActions" style="display: none; gap: 10px; justify-content: center;">
                    <button id="hitBtn" class="main-button" style="background-color: var(--neon-blue);">–í–∑—è—Ç—å –∫–∞—Ä—Ç—É</button>
                    <button id="standBtn" class="main-button" style="background-color: var(--neon-pink);">–•–≤–∞—Ç–∏—Ç</button>
                </div>
            </div>
            
            <button id="leaveTableBtn" class="main-button" style="background-color: #555; margin-top: 10px;">–ü–æ–∫–∏–Ω—É—Ç—å —Å—Ç–æ–ª</button>
        </div>
        
    </div>
</div>

<script>
    const socket = io();
    let balance = 0;
    let myPlayerId = null;
    let currentTableId = null;

    // –≠–ª–µ–º–µ–Ω—Ç—ã UI
    const balanceDisplay = document.getElementById('balanceDisplay');
    const messageDisplay = document.getElementById('messageDisplay');
    const lobbyView = document.getElementById('lobbyView');
    const tableView = document.getElementById('tableView');
    const tableList = document.getElementById('tableList');
    const createTableBtn = document.getElementById('createTableBtn');
    const createTableForm = document.getElementById('createTableForm');
    const submitCreateTableBtn = document.getElementById('submitCreateTableBtn');
    const maxPlayersInput = document.getElementById('maxPlayersInput');
    const minBetInput = document.getElementById('minBetInput');
    const betAmountInput = document.getElementById('betAmountInput');
    const placeBetBtn = document.getElementById('placeBetBtn');
    const hitBtn = document.getElementById('hitBtn');
    const standBtn = document.getElementById('standBtn');
    const gameActions = document.getElementById('gameActions');
    
    // --- –£–¢–ò–õ–ò–¢–´ ---
    function updateDisplay(msg = '') {
        balanceDisplay.textContent = `–ë–∞–ª–∞–Ω—Å: ${balance}`;
        if (msg) messageDisplay.textContent = msg;
    }
    
    function renderCard(cardStr, containerElement) {
        const rank = cardStr.slice(0, -1);
        const suit = cardStr.slice(-1);
        let symbol, color;
        
        if (suit === 'H') { symbol = '‚ô•'; color = 'var(--neon-red)'; }
        else if (suit === 'D') { symbol = '‚ô¶'; color = 'var(--neon-red)'; }
        else if (suit === 'C') { symbol = '‚ô£'; color = 'var(--black-color)'; }
        else if (suit === 'S') { symbol = '‚ô†'; color = 'var(--black-color)'; }
        else { // –î–ª—è –∑–∞–∫—Ä—ã—Ç–æ–π –∫–∞—Ä—Ç—ã (??)
            containerElement.innerHTML += `<div class="card card-back">?</div>`;
            return;
        }

        const cardHtml = `<div class="card" style="color: ${color};">${rank}<br>${symbol}</div>`;
        containerElement.innerHTML += cardHtml;
    }
    
    function showLobby() {
        tableView.style.display = 'none';
        lobbyView.style.display = 'flex';
        messageDisplay.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ —Å—Ç–æ–ª.';
    }

    function showTable() {
        lobbyView.style.display = 'none';
        tableView.style.display = 'block';
    }

    // --- –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò SOCKET.IO ---
    socket.on('connect', () => {
        socket.emit('auth_request');
    });

    socket.on('auth_success', (data) => {
        myPlayerId = data.id;
        balance = data.balance;
        updateDisplay('–£—Å–ø–µ—à–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ. –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–æ–ª–æ–≤...');
        socket.emit('get_table_list'); // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ —Å—Ç–æ–ª–æ–≤
    });
    
    socket.on('table_list', (tables) => {
        renderTableList(tables.filter(t => t.gameType === 'Blackjack'));
    });

    function renderTableList(tables) {
        tableList.innerHTML = '';
        if (tables.length === 0) {
            tableList.innerHTML = '<p style="text-align: center; color: #888;">–ê–∫—Ç–∏–≤–Ω—ã—Ö —Å—Ç–æ–ª–æ–≤ –Ω–µ—Ç.</p>';
            return;
        }
        
        tables.forEach(table => {
            const tableItem = document.createElement('div');
            const stateMessage = table.state === 'WAITING_FOR_PLAYERS' ? 
                `–û–∂–∏–¥–∞–Ω–∏–µ (–Ω—É–∂–Ω–æ ${table.minPlayersToStart - table.currentPlayers} –∏–≥—Ä–æ–∫–∞)` : 
                table.state === 'WAITING_FOR_BETS' ? '–ñ–¥–µ—Ç —Å—Ç–∞–≤–æ–∫' : '–ò–¥–µ—Ç –∏–≥—Ä–∞';

            tableItem.className = 'table-item';
            tableItem.innerHTML = `
                <div style="font-weight: bold;">–°—Ç–æ–ª: ${table.id} (${table.currentPlayers}/${table.maxPlayers})</div>
                <div>–ú–∏–Ω. —Å—Ç–∞–≤–∫–∞: ${table.minBet} | –°—Ç–∞—Ç—É—Å: ${stateMessage}</div>
                ${table.isPrivate ? '<div>üîí –ü—Ä–∏–≤–∞—Ç–Ω—ã–π</div>' : ''}
            `;
            tableItem.onclick = () => {
                if (table.isPrivate) {
                    const password = prompt("–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –¥–ª—è –ø—Ä–∏–≤–∞—Ç–Ω–æ–π –∫–æ–º–Ω–∞—Ç—ã:");
                    // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –ø–∞—Ä–æ–ª—å –Ω—É–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä
                }
                joinTable(table.id);
            };
            tableList.appendChild(tableItem);
        });
    }

    socket.on('join_success', (data) => {
        currentTableId = data.table;
        showTable();
        document.getElementById('tableName').textContent = `–°—Ç–æ–ª: ${currentTableId} (${data.gameType})`;
        updateDisplay(`–í—ã –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª–∏—Å—å –∫ —Å—Ç–æ–ª—É ${currentTableId}.`);
    });

    socket.on('table_state', (data) => {
        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Ä—É–∫–∏ –¥–∏–ª–µ—Ä–∞
        const dealerHandContainer = document.getElementById('dealerHand');
        const dealerScoreDisplay = document.getElementById('dealerScore');
        dealerHandContainer.innerHTML = '';
        dealerScoreDisplay.textContent = data.dealerScore;
        data.dealerHand.forEach(card => renderCard(card, dealerHandContainer));
        
        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Ä—É–∫ –∏–≥—Ä–æ–∫–æ–≤
        const playersContainer = document.getElementById('playersContainer');
        playersContainer.innerHTML = '';
        let myPlayerState;
        
        data.players.forEach(p => {
            if (p.id === myPlayerId) {
                myPlayerState = p;
            } else {
                 // –£–ø—Ä–æ—â–µ–Ω–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥—Ä—É–≥–∏—Ö –∏–≥—Ä–æ–∫–æ–≤
                 const playerDiv = document.createElement('div');
                 playerDiv.className = 'player-area';
                 playerDiv.style.border = p.isActive ? '2px solid var(--neon-pink)' : 'none';
                 playerDiv.innerHTML = `
                    <h3>${p.username} (${p.score}) ${p.isActive ? '‚Üê –í–ê–® –•–û–î' : ''}</h3>
                    <div class="hand-container">${p.hand.map(card => `<div class="card">${card.slice(0, -1)}<br>${card.slice(-1)}</div>`).join('')}</div>
                    <div style="font-size: 0.8em;">–°—Ç–∞–≤–∫–∞: ${p.bet || 0} ${p.stood ? ' [–•–≤–∞—Ç–∏—Ç/–ü–µ—Ä–µ–±–æ—Ä]' : ''}</div>
                 `;
                 playersContainer.appendChild(playerDiv);
            }
        });

        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ UI –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å—Ç–æ–ª–∞ –∏ –∏–≥—Ä–æ–∫–∞
        gameActions.style.display = 'none';
        placeBetBtn.style.display = 'none';

        if (data.state === 'WAITING_FOR_PLAYERS') {
            messageDisplay.textContent = `–û–∂–∏–¥–∞–Ω–∏–µ –∏–≥—Ä–æ–∫–æ–≤... (${data.currentPlayers}/${data.maxPlayers})`;
        } else if (data.state === 'WAITING_FOR_BETS') {
            messageDisplay.textContent = '–°–¥–µ–ª–∞–π—Ç–µ –≤–∞—à—É —Å—Ç–∞–≤–∫—É!';
            if (myPlayerState && myPlayerState.bet === 0) {
                placeBetBtn.style.display = 'block';
            } else {
                 messageDisplay.textContent = '–û–∂–∏–¥–∞–Ω–∏–µ —Å—Ç–∞–≤–æ–∫ –æ—Ç –¥—Ä—É–≥–∏—Ö –∏–≥—Ä–æ–∫–æ–≤...';
            }
        } else if (data.state === 'PLAYER_TURN') {
             messageDisplay.textContent = `–•–æ–¥ –∏–≥—Ä–æ–∫–∞: ${data.players[data.activePlayerIndex].username}`;
             if (myPlayerState && myPlayerState.isActive) {
                messageDisplay.textContent = '–í–ê–® –•–û–î: –í–∑—è—Ç—å –∫–∞—Ä—Ç—É –∏–ª–∏ –•–≤–∞—Ç–∏—Ç?';
                gameActions.style.display = 'flex';
                hitBtn.disabled = false; 
                standBtn.disabled = false;
            }
        } else if (data.state === 'DEALER_TURN') {
             messageDisplay.textContent = '–•–æ–¥ –î–∏–ª–µ—Ä–∞...';
        } else if (data.state === 'GAME_OVER') {
             messageDisplay.textContent = '–†–ê–£–ù–î –ó–ê–í–ï–†–®–ï–ù. –û–∂–∏–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Ä–∞—É–Ω–¥–∞...';
        }
    });
    
    socket.on('blackjack_result', (data) => {
        if (data.resultType === 'Win') {
            balance += data.winAmount;
            updateDisplay(`üéâ –ü–û–ë–ï–î–ê! –í—ã–∏–≥—Ä—ã—à: +${data.winAmount} –∫—Ä–µ–¥–∏—Ç–æ–≤!`);
        } else if (data.resultType === 'Push') {
            balance += data.winAmount; // –í–æ–∑–≤—Ä–∞—Ç —Å—Ç–∞–≤–∫–∏
            updateDisplay(`‚ÜîÔ∏è –ù–ò–ß–¨–Ø (Push)! –°—Ç–∞–≤–∫–∞ –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∞.`);
        } else if (data.resultType === 'Bust') {
            updateDisplay(`‚ùå –ü–ï–†–ï–ë–û–†! –ü—Ä–æ–∏–≥—Ä—ã—à —Å—Ç–∞–≤–∫–∏.`);
        } else {
            updateDisplay(`üôÅ –ü–†–û–ò–ì–†–´–®.`);
        }
        localStorage.setItem('casinoBalance', balance);
        
        // –û—Ç–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π –ø–æ—Å–ª–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
        hitBtn.disabled = true; 
        standBtn.disabled = true;
    });

    socket.on('return_to_lobby', (data) => {
        currentTableId = null;
        renderTableList(data.tables.filter(t => t.gameType === 'Blackjack'));
        showLobby();
        messageDisplay.textContent = '–í—ã –≤—ã—à–ª–∏ –∏–∑-–∑–∞ —Å—Ç–æ–ª–∞.';
    });

    socket.on('error_message', (msg) => {
        messageDisplay.textContent = `‚ùå –û—à–∏–±–∫–∞: ${msg}`;
    });
    
    // --- –ö–õ–ò–ï–ù–¢–°–ö–ò–ï –ö–ù–û–ü–ö–ò ---
    function joinTable(tableId) { 
        socket.emit('join_table', { tableId: tableId }); 
    }
    
    createTableBtn.onclick = () => { 
        createTableForm.style.display = createTableForm.style.display === 'none' ? 'block' : 'none';
    };
    
    submitCreateTableBtn.onclick = () => {
        const maxPlayers = parseInt(maxPlayersInput.value);
        const minBet = parseInt(minBetInput.value);
        const isPrivate = confirm("–°–¥–µ–ª–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É –ø—Ä–∏–≤–∞—Ç–Ω–æ–π (—Å –ø–∞—Ä–æ–ª–µ–º)?");
        let password = null;
        if (isPrivate) password = prompt("–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å (–∏–ª–∏ –æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º):"); // –ü–∞—Ä–æ–ª—å –Ω–µ –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω
        
        if (maxPlayers >= 2 && minBet >= 1) {
            // –ö–õ–Æ–ß–ï–í–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ü–µ—Ä–µ–¥–∞–µ–º gameType
            socket.emit('create_table', { gameType: 'Blackjack', maxPlayers, minBet, isPrivate, password });
            createTableForm.style.display = 'none';
        } else {
             alert('–ù–µ–≤–µ—Ä–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–æ–º–Ω–∞—Ç—ã.');
        }
    };
    
    placeBetBtn.onclick = () => {
        const amount = parseInt(betAmountInput.value);
        if (amount >= 10 && amount <= balance) { 
            socket.emit('place_bet', { tableId: currentTableId, amount: amount }); 
        } else {
             alert('–ù–µ–≤–µ—Ä–Ω–∞—è —Å—É–º–º–∞ —Å—Ç–∞–≤–∫–∏ –∏–ª–∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤.');
        }
    };
    
    hitBtn.onclick = () => { 
        hitBtn.disabled = true; // –û—Ç–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫–∏ –¥–æ –æ—Ç–≤–µ—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞
        standBtn.disabled = true;
        socket.emit('hit', { tableId: currentTableId }); 
    };
    
    standBtn.onclick = () => { 
        hitBtn.disabled = true; // –û—Ç–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫–∏ –¥–æ –æ—Ç–≤–µ—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞
        standBtn.disabled = true;
        socket.emit('stand', { tableId: currentTableId }); 
    };
    
    leaveTableBtn.onclick = () => { 
        if (confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø–æ–∫–∏–Ω—É—Ç—å —Å—Ç–æ–ª?")) { 
            socket.emit('leave_table'); 
        } 
    };

    // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ---
    window.onload = () => {
        const storedBalance = localStorage.getItem('casinoBalance');
        if (storedBalance) {
            balance = parseInt(storedBalance);
        } else {
            balance = 1000; 
            localStorage.setItem('casinoBalance', balance);
        }
        updateDisplay();
    };

</script>
</body>
</html>