<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Казино: Покер (Онлайн)</title>
    <!-- ПОДКЛЮЧАЕМ НОВЫЙ СТИЛЬ -->
    <link rel="stylesheet" href="style.css">
    <!-- Подключаем Socket.io -->
    <script src="/socket.io/socket.io.js"></script>
</head>
<body>

<div class="casino-wrapper" id="casinoWrapper">
    <div class="game-container">
        <a href="index.html" class="main-button" style="width: auto; padding: 5px 10px; font-size: 1em; align-self: flex-start; background: #555;">← Назад</a>
        
        <h1 style="color:var(--neon-blue); text-shadow: var(--shadow-blue);">♠️ ОНЛАЙН ПОКЕР</h1>
        
        <div class="header-controls">
            <div class="display" id="balanceDisplay">Баланс: 0</div>
        </div>
        
        <div class="display" id="messageDisplay" style="width: 90%; text-align: center; color: var(--neon-text);">Подключение...</div>

        <!-- ЛОББИ (Выбор комнат) -->
        <div id="lobbyView" style="width: 100%; display: flex; flex-direction: column; gap: 10px;">
            <h3 style="color:var(--neon-pink); margin: 5px 0;">ДОСТУПНЫЕ СТОЛЫ (ПОКЕР)</h3>
            <div id="tablesList" style="display:flex; flex-direction:column; gap:10px;">
                <!-- Комнаты будут здесь -->
            </div>
            <!-- (Кнопка создания комнаты для покера пока отключена, так как логика сложнее) -->
        </div>

        <!-- ИГРА -->
        <div class="game-view" id="gameView" style="display: none; width: 100%;">
            
            <h3 style="color:var(--neon-blue); margin-bottom: 0;">ОБЩИЙ БАНК (ПОТ): <span id="potAmount">0</span></h3>
            <div class="community-cards hand-container" id="communityCards">
                <!-- Общие карты -->
            </div>

            <!-- Рука Игрока -->
            <h3 style="color:var(--neon-green); margin-bottom: 0;">ВАША РУКА</h3>
            <div id="playerHand" class="hand-container"></div>
            
            <!-- Место для других игроков -->
            <div id="otherPlayersInfo" style="margin-top: 10px; font-size: 0.9em; width: 100%; text-align: left;">
                <!-- Информация о других игроках -->
            </div>

            <!-- Контроль Игры -->
            <div id="actionButtons" class="poker-controls" style="display: none;">
                <button id="foldBtn" class="main-button" style="background: var(--neon-red); box-shadow: var(--shadow-red); padding: 10px 15px; font-size: 1em;">ФОЛД</button>
                <button id="checkCallBtn" class="main-button" style="padding: 10px 15px; font-size: 1em;">ЧЕК/КОЛЛ</button>
                <input type="number" id="raiseAmount" value="50" min="10" class="bet-input" style="width: 80px;">
                <button id="raiseBtn" class="main-button" style="background: var(--neon-pink); box-shadow: var(--shadow-pink); padding: 10px 15px; font-size: 1em;">РЕЙЗ</button>
            </div>
            
            <button id="leaveTableBtn" class="main-button" style="margin-top: 20px; background: #444; box-shadow: none; padding: 10px;">ВЫЙТИ ИЗ КОМНАТЫ</button>
        </div>
    </div>
</div>

<script>
    // ====================================================================
    // --- КЛИЕНТСКИЙ JAVASCRIPT (ПОКЕР - УПРОЩЕННЫЙ) ---
    // ====================================================================
    
    const socket = io();
    let balance = 1000;
    let playerId = null;
    let currentTableId = null;

    // --- DOM Элементы ---
    // (Аналогично Блэкджеку, получаем все элементы по ID)
    const balanceDisplay = document.getElementById('balanceDisplay');
    const messageDisplay = document.getElementById('messageDisplay');
    const lobbyView = document.getElementById('lobbyView');
    const gameView = document.getElementById('gameView');
    const tablesList = document.getElementById('tablesList');
    
    const communityCardsEl = document.getElementById('communityCards');
    const playerHandEl = document.getElementById('playerHand');
    const potAmountEl = document.getElementById('potAmount');
    const otherPlayersInfoEl = document.getElementById('otherPlayersInfo');
    
    const actionButtons = document.getElementById('actionButtons');
    const foldBtn = document.getElementById('foldBtn');
    const checkCallBtn = document.getElementById('checkCallBtn');
    const raiseAmountInput = document.getElementById('raiseAmount');
    const raiseBtn = document.getElementById('raiseBtn');
    const leaveTableBtn = document.getElementById('leaveTableBtn');

    // --- Утилиты UI (Копируем из Блэкджека) ---
    function renderCard(cardData, isFaceDown = false) {
        const cardContainer = document.createElement('div');
        cardContainer.className = 'card-container';
        
        const rank = cardData.length > 1 ? cardData.slice(0, -1) : '?';
        const suit = cardData.length > 1 ? cardData.slice(-1) : '?';
        
        const suitsMap = { 'C': '♣', 'D': '♦', 'H': '♥', 'S': '♠' };
        const isRed = suit === 'H' || suit === 'D';
        const suitSymbol = suitsMap[suit] || '?';
        
        if (isFaceDown) {
            cardContainer.innerHTML = `<div class="card card-back">POKER</div>`;
        } else {
            cardContainer.innerHTML = `
                <div class="card ${isRed ? 'red-suit' : ''}">
                    <span style="align-self: flex-start; margin-left: 3px; font-size: 0.8em;">${rank}</span>
                    <span class="card-suit-symbol">${suitSymbol}</span>
                    <span style="align-self: flex-end; margin-right: 3px; font-size: 0.8em; transform:rotate(180deg);">${rank}</span>
                </div>
            `;
        }
        return cardContainer;
    }

    function updateGlobalBalance(newBalance) {
        balance = newBalance;
        balanceDisplay.textContent = `Баланс: ${balance}`;
        localStorage.setItem('casinoBalance', balance);
    }

    function showLobby() {
        lobbyView.style.display = 'flex';
        gameView.style.display = 'none';
        currentTableId = null;
        messageDisplay.textContent = 'Выберите стол для игры в Покер.';
        socket.emit('auth_request'); 
    }

    function showGame(tableId) {
        lobbyView.style.display = 'none';
        gameView.style.display = 'flex';
        currentTableId = tableId;
    }

    // --- SOCKET.IO СЛУШАТЕЛИ (ПОКЕР) ---
    
    socket.on('connect', () => { 
        balance = parseInt(localStorage.getItem('casinoBalance')) || 1000;
        socket.emit('auth_request'); 
    });
    
    socket.on('auth_success', (data) => {
        playerId = data.id;
        updateGlobalBalance(data.balance);
        if (!currentTableId) {
            renderTableList(data.tables);
            showLobby();
        }
    });
    
    socket.on('update_table_list', (tables) => {
        if (!currentTableId) {
            renderTableList(tables);
        }
    });

    function renderTableList(tables) {
        tablesList.innerHTML = '';
        tables.filter(t => t.gameType === 'Poker').forEach(table => {
            const item = document.createElement('div');
            item.className = 'table-item';
            const statusColor = table.currentPlayers >= table.maxPlayers ? 'var(--neon-red)' : 'var(--neon-green)';
            
            item.innerHTML = `
                <div style="text-align: left;">
                    <span style="color:var(--neon-blue);">${table.name || table.id} (ID: ${table.id})</span><br>
                    <span style="font-size: 0.9em;">Мин. Бай-ин: ${table.minBet} | 
                    <span style="color:${statusColor};">Игроков: ${table.currentPlayers}/${table.maxPlayers}</span></span>
                </div>
                <button class="main-button" onclick="joinTable('${table.id}')" 
                        style="width: auto; padding: 5px 15px; font-size: 1em;"
                        ${table.currentPlayers >= table.maxPlayers ? 'disabled' : ''}>
                    СЕСТЬ
                </button>
            `;
            tablesList.appendChild(item);
        });
    }
    
    socket.on('game_start', (data) => {
        showGame(data.tableId);
    });
    
    // ГЛАВНЫЙ ОБНОВИТЕЛЬ СТОЛА (ПОКЕР)
    socket.on('table_state', (data) => {
        if (!currentTableId) return; 
        
        communityCardsEl.innerHTML = '';
        playerHandEl.innerHTML = '';
        otherPlayersInfoEl.innerHTML = '';
        
        // Рендер Общих карт
        data.communityCards.forEach(cardRank => {
            communityCardsEl.appendChild(renderCard(cardRank, false));
        });
        
        potAmountEl.textContent = data.pot;

        // Рендер Игроков
        data.players.forEach(p => {
            if (p.id === playerId) {
                // Это мы
                p.hand.forEach(cardRank => {
                    playerHandEl.appendChild(renderCard(cardRank, false));
                });
            } else {
                // Другие игроки
                const playerInfo = document.createElement('p');
                playerInfo.textContent = `${p.username}: ${p.bet} фишек. (Статус: ${p.status})`;
                if (p.status === 'active') playerInfo.style.color = 'var(--neon-green)';
                if (p.status === 'folded') playerInfo.style.color = 'var(--neon-red)';
                otherPlayersInfoEl.appendChild(playerInfo);
            }
        });
        
        // Управление UI
        const selfData = data.players.find(p => p.id === playerId);
        if (data.state === 'PLAYER_TURN' && selfData && selfData.active) {
            actionButtons.style.display = 'flex';
            messageDisplay.textContent = 'ВАШ ХОД!';
            // (Здесь должна быть логика для "Чек" или "Колл" в зависимости от ставки)
        } else {
            actionButtons.style.display = 'none';
            messageDisplay.textContent = 'Ожидаем хода...';
        }
    });

    socket.on('game_results', (data) => {
        // ... (логика отображения результата покера) ...
        messageDisplay.innerHTML = `<strong>${data.winnerUsername} ВЫИГРАЛ ${data.pot} с ${data.handRank}!</strong>`;
        
        setTimeout(() => {
             messageDisplay.textContent = 'Ожидание нового раунда...';
        }, 5000);
    });
    
    socket.on('return_to_lobby', (data) => {
        currentTableId = null;
        renderTableList(data.tables);
        showLobby();
        messageDisplay.textContent = 'Вы вышли из-за стола.';
    });

    socket.on('error_message', (msg) => {
        messageDisplay.textContent = `❌ Ошибка: ${msg}`;
    });
    
    // --- КЛИЕНТСКИЕ КНОПКИ (ПОКЕР) ---
    
    function joinTable(tableId) { 
        socket.emit('join_table', { tableId: tableId, gameType: 'Poker', wantsBots: true }); 
    }
    
    foldBtn.onclick = () => { socket.emit('fold', { tableId: currentTableId }); };
    checkCallBtn.onclick = () => { socket.emit('call_check', { tableId: currentTableId }); };
    raiseBtn.onclick = () => { 
        const amount = parseInt(raiseAmountInput.value);
        socket.emit('raise', { tableId: currentTableId, amount: amount }); 
    };
    
    leaveTableBtn.onclick = () => { 
        if (confirm("Вы уверены, что хотите покинуть стол?")) { 
            socket.emit('leave_table'); 
        } 
    };

    // --- Инициализация ---
    window.onload = () => {
        const storedBalance = localStorage.getItem('casinoBalance');
        if (storedBalance) {
            balance = parseInt(storedBalance);
        }
        updateGlobalBalance(balance);
        showLobby(); 
    };
</script>
</body>
</html>