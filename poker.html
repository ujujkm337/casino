<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ö–∞–∑–∏–Ω–æ: –ü–æ–∫–µ—Ä (–û–Ω–ª–∞–π–Ω)</title>
    <link rel="stylesheet" href="style.css">
    <script src="/socket.io/socket.io.js"></script>
</head>
<body>

<div class="casino-wrapper" id="casinoWrapper">
    <div class="game-container">
        <a href="index.html" class="main-button" style="width: auto; padding: 5px 10px; font-size: 1em; align-self: flex-start; background: #555;">‚Üê –ù–∞–∑–∞–¥</a>
        
        <h1 style="color:var(--neon-blue); text-shadow: var(--shadow-blue);">‚ô†Ô∏è –û–ù–õ–ê–ô–ù –ü–û–ö–ï–†</h1>
        
        <div class="header-controls">
            <div class="display" id="balanceDisplay">–ë–∞–ª–∞–Ω—Å: 0</div>
        </div>
        
        <div class="display" id="messageDisplay" style="width: 90%; text-align: center; color: var(--neon-text);">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</div>

        <div id="lobbyView" style="width: 100%; display: flex; flex-direction: column; align-items: center; gap: 10px;">
             <div style="display: flex; gap: 10px; width: 100%; max-width: 400px; justify-content: center;">
                <button class="main-button" id="createTableBtn">–°–æ–∑–¥–∞—Ç—å –°—Ç–æ–ª</button>
            </div>
            <div id="createTableForm" class="form-panel" style="display: none; width: 100%; max-width: 400px;">
                 <h2>–°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç–æ–ª–∞</h2>
                 <label for="maxPlayersInput">–ú–∞–∫—Å. –∏–≥—Ä–æ–∫–æ–≤ (2-6):</label>
                 <input type="number" id="maxPlayersInput" min="2" max="6" value="4">
                 <label for="minBetInput">–ú–∏–Ω. —Å—Ç–∞–≤–∫–∞ (–ë–ª–∞–π–Ω–¥—ã):</label>
                 <input type="number" id="minBetInput" min="10" value="50">
                 <button class="main-button" id="submitTableBtn">–°–æ–∑–¥–∞—Ç—å</button>
            </div>
            <h2>–î–æ—Å—Ç—É–ø–Ω—ã–µ —Å—Ç–æ–ª—ã:</h2>
            <div id="lobbyTables" class="table-list" style="width: 100%; max-width: 500px;">
                </div>
        </div>

        <div id="tableView" style="display: none; width: 100%; max-width: 600px; text-align: center;">
            <h2 id="tableTitle">–°—Ç–æ–ª: P1 (–ü–æ–∫–µ—Ä)</h2>
            <button class="main-button" id="leaveTableBtn" style="background: var(--neon-red);">–ü–æ–∫–∏–Ω—É—Ç—å —Å—Ç–æ–ª</button>

            <div class="player-panel" style="border-color: var(--neon-pink); margin-top: 15px;">
                <div class="player-info">–ë–∞–Ω–∫: <span id="potAmount">0</span> | –û–±—â–∏–µ –∫–∞—Ä—Ç—ã:</div>
                <div id="communityCards" class="hand-container"></div>
            </div>

            <div id="playersContainer" style="margin-top: 15px; width: 100%;">
                </div>

            <div class="controls-panel">
                <div class="game-actions" style="margin-top: 10px;">
                    <button class="main-button" id="foldBtn">–§–æ–ª–¥</button>
                    <button class="main-button" id="checkCallBtn">–ß–µ–∫/–ö–æ–ª–ª</button>
                    <input type="number" id="raiseAmountInput" placeholder="–†–µ–π–∑" value="100" min="50" style="width: 80px;">
                    <button class="main-button" id="raiseBtn">–†–µ–π–∑</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const socket = io();
    let currentTableId = null;
    let balance = 0;
    let myPlayerId = null;
    let myUsername = '';

    // –≠–ª–µ–º–µ–Ω—Ç—ã
    const balanceDisplay = document.getElementById('balanceDisplay');
    const messageDisplay = document.getElementById('messageDisplay');
    const lobbyView = document.getElementById('lobbyView');
    const tableView = document.getElementById('tableView');
    const lobbyTables = document.getElementById('lobbyTables');
    const playersContainer = document.getElementById('playersContainer');
    const foldBtn = document.getElementById('foldBtn');
    const checkCallBtn = document.getElementById('checkCallBtn');
    const raiseBtn = document.getElementById('raiseBtn');
    const raiseAmountInput = document.getElementById('raiseAmountInput');
    const leaveTableBtn = document.getElementById('leaveTableBtn');
    const createTableBtn = document.getElementById('createTableBtn');
    const submitTableBtn = document.getElementById('submitTableBtn');
    const maxPlayersInput = document.getElementById('maxPlayersInput');
    const minBetInput = document.getElementById('minBetInput');
    const createTableForm = document.getElementById('createTableForm');


    // --- –£–¢–ò–õ–ò–¢–´ –ö–õ–ò–ï–ù–¢–ê ---
    function updateDisplay(msg) {
        if (msg) messageDisplay.textContent = msg;
        balanceDisplay.textContent = `–ë–∞–ª–∞–Ω—Å: ${balance}`;
    }
    
    function showLobby() {
        tableView.style.display = 'none';
        lobbyView.style.display = 'flex';
        // –°–±—Ä–æ—Å –∫–Ω–æ–ø–æ–∫
        foldBtn.disabled = true;
        checkCallBtn.disabled = true;
        raiseBtn.disabled = true;
    }

    function showTable() {
        lobbyView.style.display = 'none';
        tableView.style.display = 'flex';
        createTableForm.style.display = 'none';
    }

    function renderCard(cardStr) {
        if (!cardStr) return '<div class="card card-back">?</div>';
        const rank = cardStr.slice(0, -1);
        const suit = cardStr.slice(-1);
        const suitSymbol = suit === 'H' ? '‚ô•' : suit === 'D' ? '‚ô¶' : suit === 'C' ? '‚ô£' : '‚ô†';
        const color = (suit === 'H' || suit === 'D') ? 'card-suit-red' : 'card-suit-black';
        return `<div class="card ${color}">${rank}<br>${suitSymbol}</div>`;
    }
    
    // --- –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –°–û–ö–ï–¢–û–í ---
    
    socket.on('connect', () => {
        socket.emit('auth_request');
    });

    socket.on('auth_success', (data) => {
        myPlayerId = data.id;
        balance = data.balance;
        updateDisplay('–ü–æ–¥–∫–ª—é—á–µ–Ω–æ! –í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–æ–ª.');
        if (data.username) myUsername = data.username;
    });

    socket.on('table_list', (tables) => {
        // –ö–õ–Æ–ß–ï–í–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –§—É–Ω–∫—Ü–∏—è, –∫–æ—Ç–æ—Ä–∞—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç NaN –∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Å—Ç–∞—Ç—É—Å
        renderTableList(tables.filter(t => t.gameType === 'Poker'));
    });

    /**
     * –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï NaN –∏ –°–¢–ê–¢–£–°–ê:
     */
    function renderTableList(tables) {
        lobbyTables.innerHTML = '';
        
        tables.sort((a, b) => (a.isPrivate === b.isPrivate ? 0 : a.isPrivate ? 1 : -1));

        tables.forEach(table => {
            const playersCount = parseInt(table.currentPlayers) || 0; 
            const maxPlayers = parseInt(table.maxPlayers) || 0;
            
            // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï NaN: –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º, —á—Ç–æ —á–∏—Å–ª–æ –∏–≥—Ä–æ–∫–æ–≤ –∫ –æ–∂–∏–¥–∞–Ω–∏—é –Ω–µ –º–µ–Ω—å—à–µ 0
            const neededPlayers = Math.max(0, maxPlayers - playersCount); 

            // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –°–¢–ê–¢–£–°–ê
            let tableStatus;
            if (table.state === 'PRE_FLOP' || table.state === 'FLOP' || table.state === 'TURN' || table.state === 'RIVER') {
                tableStatus = '–ò–≥—Ä–∞ –∏–¥–µ—Ç';
            } else if (playersCount === maxPlayers) {
                tableStatus = '–û–∂–∏–¥–∞–Ω–∏–µ —Å—Ç–∞—Ä—Ç–∞';
            } else if (table.isPrivate) {
                tableStatus = `–ü—Ä–∏–≤–∞—Ç–Ω–∞—è (–Ω—É–∂–Ω–æ ${neededPlayers} –∏–≥—Ä–æ–∫–∞)`;
            } else {
                tableStatus = `–û–∂–∏–¥–∞–Ω–∏–µ (–Ω—É–∂–Ω–æ ${neededPlayers} –∏–≥—Ä–æ–∫–∞)`;
            }

            const icon = '‚ô†Ô∏è';
            const lock = table.isPrivate ? ' üîí' : '';

            const html = `
                <div class="table-item" onclick="joinTable('${table.id}', '${table.isPrivate ? 'private' : 'public'}')">
                    ${icon} –°—Ç–æ–ª: ${table.id}${lock} (${playersCount}/${maxPlayers})
                    <br>–ú–∏–Ω. —Å—Ç–∞–≤–∫–∞: ${table.minBet} | –°—Ç–∞—Ç—É—Å: <strong>${tableStatus}</strong>
                </div>
            `;
            lobbyTables.innerHTML += html;
        });
    }

    socket.on('table_joined', (data) => {
        currentTableId = data.tableId;
        document.getElementById('tableTitle').textContent = `–°—Ç–æ–ª: ${data.tableId} (${data.gameType})`;
        raiseAmountInput.value = data.minBet * 2; // –ù–∞—á–∞–ª—å–Ω—ã–π —Ä–µ–π–∑
        showTable();
        updateDisplay('–í—ã –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª–∏—Å—å –∫ —Å—Ç–æ–ª—É. –û–∂–∏–¥–∞–Ω–∏–µ –¥—Ä—É–≥–∏—Ö –∏–≥—Ä–æ–∫–æ–≤.');
    });

    socket.on('table_state', (tableState) => {
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ–±—â–µ–≥–æ –±–∞–Ω–∫–∞
        document.getElementById('potAmount').textContent = tableState.pot || 0;
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ–±—â–∏—Ö –∫–∞—Ä—Ç (—É–ø—Ä–æ—â–µ–Ω–Ω–æ: –µ—Å–ª–∏ –µ—Å—Ç—å, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º)
        const communityCardsElement = document.getElementById('communityCards');
        communityCardsElement.innerHTML = tableState.communityCards 
            ? tableState.communityCards.map(card => renderCard(card)).join('')
            : '–û–∂–∏–¥–∞–Ω–∏–µ —Ä–∞–∑–¥–∞—á–∏...';

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–≥—Ä–æ–∫–æ–≤
        playersContainer.innerHTML = '';
        tableState.players.forEach(p => {
            const isMe = p.id === myPlayerId;
            const isMyTurn = p.id === tableState.activePlayerId;
            const classList = ['player-panel'];
            if (isMe) classList.push('my-player');
            if (isMyTurn) classList.push('active-turn');

            const playerHtml = `
                <div id="player-${p.id}" class="${classList.join(' ')}" style="border-color: ${isMe ? 'var(--neon-green)' : 'var(--neon-text)'};">
                    <div class="player-info">${p.username} ${isMe ? '(–í—ã)' : ''} | <span style="font-weight: bold; color: ${p.isFolded ? 'var(--neon-red)' : isMyTurn ? 'var(--neon-blue)' : 'var(--neon-text)'}">${p.isFolded ? '–§–û–õ–î' : isMyTurn ? '–•–æ–¥' : '–û–∂–∏–¥–∞–Ω–∏–µ'}</span> | –°—Ç–∞–≤–∫–∞ –≤ –±–∞–Ω–∫–µ: ${p.totalBet}</div>
                    <div class="hand-container">
                        ${isMe || tableState.state === 'RESULTS' 
                            ? p.hand.map(card => renderCard(card)).join('') 
                            : p.hand.map(() => renderCard(null)).join('')
                        }
                    </div>
                </div>
            `;
            playersContainer.innerHTML += playerHtml;
            
            // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–∞–º–∏
            if (isMe) {
                 foldBtn.disabled = !isMyTurn || p.isFolded;
                 checkCallBtn.disabled = !isMyTurn || p.isFolded;
                 raiseBtn.disabled = !isMyTurn || p.isFolded;
                 
                 // –õ–æ–≥–∏–∫–∞ –ß–ï–ö/–ö–û–õ–õ
                 if (tableState.currentBet === 0) { // –ï—Å–ª–∏ –Ω–µ—Ç —Å—Ç–∞–≤–∫–∏, —Ç–æ —ç—Ç–æ –ß–ï–ö
                     checkCallBtn.textContent = '–ß–µ–∫';
                 } else { // –ò–Ω–∞—á–µ —ç—Ç–æ –ö–û–õ–õ
                     const callAmount = tableState.currentBet - p.currentBet;
                     checkCallBtn.textContent = `–ö–æ–ª–ª (${callAmount})`;
                 }
            }
        });
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ–±—â–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
        if (tableState.state === 'PLAYER_TURN') {
             const activePlayer = tableState.players.find(p => p.id === tableState.activePlayerId);
             updateDisplay(`–•–æ–¥ –∏–≥—Ä–æ–∫–∞: ${activePlayer.username}.`);
        } else if (tableState.state === 'PRE_FLOP') {
             updateDisplay('–†–∞–∑–¥–∞—á–∞ –∫–∞—Ä—Ç. –ù–∞—á–∏–Ω–∞–µ—Ç—Å—è PRE-FLOP.');
        } else if (tableState.state === 'RESULTS') {
             updateDisplay(`–†–∞—É–Ω–¥ –∑–∞–≤–µ—Ä—à–µ–Ω! –ü–æ–±–µ–¥–∏—Ç–µ–ª—å: ${tableState.winnerId}.`);
        } else {
             updateDisplay('–û–∂–∏–¥–∞–Ω–∏–µ –Ω–∞—á–∞–ª–∞ –∏–≥—Ä—ã...');
        }
    });
    
    socket.on('winner_announced', (data) => {
        messageDisplay.innerHTML = `üéâ –ü–û–ë–ï–î–ê! –ü–æ–±–µ–¥–∏—Ç–µ–ª—å: ${data.username} —Å ${data.handRank}!<strong> –ë–∞–Ω–∫: ${data.pot}</strong>`;
        setTimeout(() => {
             messageDisplay.textContent = '–û–∂–∏–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Ä–∞—É–Ω–¥–∞...';
        }, 5000);
    });
    
    socket.on('return_to_lobby', (data) => {
        currentTableId = null;
        renderTableList(data.tables);
        showLobby();
        messageDisplay.textContent = '–í—ã –≤—ã—à–ª–∏ –∏–∑-–∑–∞ —Å—Ç–æ–ª–∞.';
    });

    socket.on('error_message', (msg) => {
        alert(`–û—à–∏–±–∫–∞: ${msg}`);
        // –°–±—Ä–æ—Å –∫–Ω–æ–ø–æ–∫ –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏
        foldBtn.disabled = false;
        checkCallBtn.disabled = false;
        raiseBtn.disabled = false;
        messageDisplay.textContent = `‚ùå –û—à–∏–±–∫–∞: ${msg}`;
    });

    // --- –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –ö–ù–û–ü–û–ö ---
    
    createTableBtn.onclick = () => { createTableForm.style.display = 'flex'; };
    
    submitTableBtn.onclick = () => {
        const maxPlayers = parseInt(maxPlayersInput.value);
        const minBet = parseInt(minBetInput.value);
        const isPrivate = confirm("–°–¥–µ–ª–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É –ø—Ä–∏–≤–∞—Ç–Ω–æ–π (—Å –ø–∞—Ä–æ–ª–µ–º)?");
        let password = null;
        if (isPrivate) password = prompt("–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å (–∏–ª–∏ –æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º):");
        
        if (maxPlayers >= 2 && minBet >= 1) {
            // –ö–õ–Æ–ß–ï–í–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ü–µ—Ä–µ–¥–∞–µ–º gameType
            socket.emit('create_table', { gameType: 'Poker', maxPlayers, minBet, isPrivate, password });
            createTableForm.style.display = 'none';
        } else {
             alert('–ù–µ–≤–µ—Ä–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–æ–º–Ω–∞—Ç—ã.');
        }
    };

    function joinTable(tableId) { 
        socket.emit('join_table', { tableId: tableId, wantsBots: true }); 
    }
    
    foldBtn.onclick = () => { socket.emit('fold', { tableId: currentTableId }); };
    checkCallBtn.onclick = () => { socket.emit('call_check', { tableId: currentTableId }); };
    raiseBtn.onclick = () => { 
        const amount = parseInt(raiseAmountInput.value);
        if (amount <= balance && amount > 0) {
            socket.emit('raise', { tableId: currentTableId, amount: amount }); 
        } else {
            alert('–ù–µ–≤–µ—Ä–Ω–∞—è —Å—É–º–º–∞ —Ä–µ–π–∑–∞.');
        }
    };
    
    leaveTableBtn.onclick = () => { 
        if (confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø–æ–∫–∏–Ω—É—Ç—å —Å—Ç–æ–ª?")) { 
            socket.emit('leave_table'); 
        } 
    };

    // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ---
    window.onload = () => {
        // ... (–ª–æ–≥–∏–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–∞–ª–∞–Ω—Å–∞ –∏ —Ç.–ø.)
    };
</script>
</body>
</html>