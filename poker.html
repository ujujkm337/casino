<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ö–∞–∑–∏–Ω–æ: –ü–æ–∫–µ—Ä (–û–Ω–ª–∞–π–Ω)</title>
    <link rel="stylesheet" href="style.css">
    <script src="/socket.io/socket.io.js"></script>
</head>
<body>

<div class="casino-wrapper" id="casinoWrapper">
    <div class="game-container">
        <a href="index.html" class="main-button" style="width: auto; padding: 5px 10px; font-size: 1em; align-self: flex-start; background: #555;">‚Üê –ù–∞–∑–∞–¥</a>
        
        <h1 style="color:var(--neon-blue); text-shadow: var(--shadow-blue);">‚ô†Ô∏è –û–ù–õ–ê–ô–ù –ü–û–ö–ï–†</h1>
        
        <div class="header-controls">
            <div class="display" id="balanceDisplay">–ë–∞–ª–∞–Ω—Å: 0</div>
        </div>
        
        <div class="display" id="messageDisplay" style="width: 90%; text-align: center; color: var(--neon-text);">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</div>

        <div id="lobbyView" style="width: 100%; display: flex; flex-direction: column; align-items: center; gap: 10px;">
            <div id="tableList" class="table-list" style="width: 100%; max-width: 400px; display: flex; flex-direction: column; gap: 5px;">
                </div>
            
            <button id="createTableBtn" class="main-button" style="background-color: var(--neon-green); box-shadow: var(--shadow-green);">–°–æ–∑–¥–∞—Ç—å —Å–≤–æ—é –∫–æ–º–Ω–∞—Ç—É</button>
            
            <div id="createTableForm" style="display: none; width: 100%; max-width: 400px; padding: 10px; background: var(--neon-metal); border-radius: 5px;">
                <label>–ú–∞–∫—Å. –∏–≥—Ä–æ–∫–æ–≤: <input type="number" id="maxPlayersInput" value="6" min="2" max="9"></label><br>
                <label>–ú–∏–Ω. —Å—Ç–∞–≤–∫–∞: <input type="number" id="minBetInput" value="20" min="1"></label><br>
                <button id="submitCreateTableBtn" class="main-button">–°–æ–∑–¥–∞—Ç—å</button>
            </div>
        </div>

        <div id="tableView" style="display: none; width: 100%; max-width: 600px; padding: 10px; border: 1px solid var(--neon-blue); border-radius: 10px;">
            
            <h2 id="tableName" style="text-align: center; color: var(--neon-blue); font-size: 1.5em;">–°—Ç–æ–ª: </h2>
            <h3 id="potDisplay" style="text-align: center; color: var(--neon-green);">–ë–∞–Ω–∫: 0</h3>
            
            <div id="communityCards" class="hand-container" style="min-height: 85px;">
                </div>
            
            <div id="playersContainer" style="margin-bottom: 20px; display: flex; flex-wrap: wrap; justify-content: center; gap: 10px;">
                </div>
            
            <div id="playerControls" style="display: none; flex-direction: column; gap: 10px;">
                <div id="gameActions" style="display: none; gap: 10px; justify-content: center;">
                    <button id="foldBtn" class="main-button" style="background-color: var(--neon-red);">–°–±—Ä–æ—Å–∏—Ç—å (Fold)</button>
                    <button id="checkCallBtn" class="main-button" style="background-color: var(--neon-blue);">–ß–µ–∫/–ö–æ–ª–ª</button>
                    <div style="display: flex; gap: 5px;">
                        <input type="number" id="raiseAmountInput" value="40" min="20" style="width: 80px; text-align: center;">
                        <button id="raiseBtn" class="main-button" style="background-color: var(--neon-pink);">–†–µ–π–∑</button>
                    </div>
                </div>
            </div>
            
            <button id="leaveTableBtn" class="main-button" style="background-color: #555; margin-top: 10px;">–ü–æ–∫–∏–Ω—É—Ç—å —Å—Ç–æ–ª</button>
        </div>
        
    </div>
</div>

<script>
    const socket = io();
    let balance = 0;
    let myPlayerId = null;
    let currentTableId = null;

    // –≠–ª–µ–º–µ–Ω—Ç—ã UI
    const balanceDisplay = document.getElementById('balanceDisplay');
    const messageDisplay = document.getElementById('messageDisplay');
    const lobbyView = document.getElementById('lobbyView');
    const tableView = document.getElementById('tableView');
    const tableList = document.getElementById('tableList');
    const createTableBtn = document.getElementById('createTableBtn');
    const createTableForm = document.getElementById('createTableForm');
    const submitCreateTableBtn = document.getElementById('submitCreateTableBtn');
    const maxPlayersInput = document.getElementById('maxPlayersInput');
    const minBetInput = document.getElementById('minBetInput');
    const foldBtn = document.getElementById('foldBtn');
    const checkCallBtn = document.getElementById('checkCallBtn');
    const raiseBtn = document.getElementById('raiseBtn');
    const raiseAmountInput = document.getElementById('raiseAmountInput');
    const gameActions = document.getElementById('gameActions');
    
    // --- –£–¢–ò–õ–ò–¢–´ ---
    function updateDisplay(msg = '') {
        balanceDisplay.textContent = `–ë–∞–ª–∞–Ω—Å: ${balance}`;
        if (msg) messageDisplay.textContent = msg;
    }
    
    function renderCard(cardStr, containerElement) {
        const rank = cardStr.slice(0, -1);
        const suit = cardStr.slice(-1);
        let symbol, color;
        
        if (suit === 'H') { symbol = '‚ô•'; color = 'var(--neon-red)'; }
        else if (suit === 'D') { symbol = '‚ô¶'; color = 'var(--neon-red)'; }
        else if (suit === 'C') { symbol = '‚ô£'; color = 'var(--black-color)'; }
        else if (suit === 'S') { symbol = '‚ô†'; color = 'var(--black-color)'; }
        else { 
            containerElement.innerHTML += `<div class="card card-back">?</div>`;
            return;
        }

        const cardHtml = `<div class="card" style="color: ${color};">${rank}<br>${symbol}</div>`;
        containerElement.innerHTML += cardHtml;
    }
    
    function showLobby() {
        tableView.style.display = 'none';
        lobbyView.style.display = 'flex';
        messageDisplay.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ —Å—Ç–æ–ª.';
    }

    function showTable() {
        lobbyView.style.display = 'none';
        tableView.style.display = 'block';
    }

    // --- –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò SOCKET.IO ---
    socket.on('connect', () => {
        socket.emit('auth_request');
    });

    socket.on('auth_success', (data) => {
        myPlayerId = data.id;
        balance = data.balance;
        updateDisplay('–£—Å–ø–µ—à–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ. –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–æ–ª–æ–≤...');
        socket.emit('get_table_list'); 
    });
    
    socket.on('table_list', (tables) => {
        renderTableList(tables.filter(t => t.gameType === 'Poker'));
    });

    function renderTableList(tables) {
        tableList.innerHTML = '';
        if (tables.length === 0) {
            tableList.innerHTML = '<p style="text-align: center; color: #888;">–ê–∫—Ç–∏–≤–Ω—ã—Ö —Å—Ç–æ–ª–æ–≤ –Ω–µ—Ç.</p>';
            return;
        }
        
        tables.forEach(table => {
            const tableItem = document.createElement('div');
            const stateMessage = table.state === 'WAITING_FOR_PLAYERS' ? 
                `–û–∂–∏–¥–∞–Ω–∏–µ (–Ω—É–∂–Ω–æ ${table.minPlayersToStart - table.currentPlayers} –∏–≥—Ä–æ–∫–∞)` : 
                table.state === 'WAITING_FOR_BETS' ? '–ñ–¥–µ—Ç —Å—Ç–∞–≤–æ–∫' : '–ò–¥–µ—Ç –∏–≥—Ä–∞';

            tableItem.className = 'table-item';
            tableItem.innerHTML = `
                <div style="font-weight: bold;">–°—Ç–æ–ª: ${table.id} (${table.currentPlayers}/${table.maxPlayers})</div>
                <div>–ú–∏–Ω. —Å—Ç–∞–≤–∫–∞: ${table.minBet} | –°—Ç–∞—Ç—É—Å: ${stateMessage}</div>
                ${table.isPrivate ? '<div>üîí –ü—Ä–∏–≤–∞—Ç–Ω—ã–π</div>' : ''}
            `;
            tableItem.onclick = () => { joinTable(table.id); };
            tableList.appendChild(tableItem);
        });
    }

    socket.on('join_success', (data) => {
        currentTableId = data.table;
        showTable();
        document.getElementById('tableName').textContent = `–°—Ç–æ–ª: ${currentTableId} (${data.gameType})`;
        updateDisplay(`–í—ã –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª–∏—Å—å –∫ —Å—Ç–æ–ª—É ${currentTableId}.`);
    });

    socket.on('table_state', (data) => {
        // –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞ –¥–ª—è –ü–æ–∫–µ—Ä–∞ (—Ñ–æ–∫—É—Å –Ω–∞ –æ–∂–∏–¥–∞–Ω–∏–∏ –∏ –ª–æ–±–±–∏)
        
        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –æ–±—â–∏—Ö –∫–∞—Ä—Ç (—É–ø—Ä–æ—â–µ–Ω–Ω–æ)
        const communityCardsContainer = document.getElementById('communityCards');
        communityCardsContainer.innerHTML = '–û–±—â–∏–µ –∫–∞—Ä—Ç—ã: ';
        // data.communityCards?.forEach(card => renderCard(card, communityCardsContainer)); 
        
        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ—Ç–∞
        // document.getElementById('potDisplay').textContent = `–ë–∞–Ω–∫: ${data.pot || 0}`;

        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ UI –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å—Ç–æ–ª–∞
        gameActions.style.display = 'none';

        if (data.state === 'WAITING_FOR_PLAYERS') {
            messageDisplay.textContent = `–û–∂–∏–¥–∞–Ω–∏–µ –∏–≥—Ä–æ–∫–æ–≤... (${data.currentPlayers}/${data.maxPlayers})`;
        } else if (data.state === 'WAITING_FOR_BETS') {
            messageDisplay.textContent = '–ñ–¥–µ–º —Å—Ç–∞–≤–æ–∫ (–¥–ª—è –ø–æ–∫–µ—Ä–∞ —ç—Ç–æ –±–ª–∞–π–Ω–¥—ã)...';
        } else if (data.state === 'PREFLOP' || data.state === 'FLOP' || data.state === 'TURN' || data.state === 'RIVER') {
             messageDisplay.textContent = `–†–∞—É–Ω–¥: ${data.state}`;
             const activePlayer = data.players.find(p => p.isActive);
             if (activePlayer) {
                 messageDisplay.textContent += ` | –•–æ–¥ –∏–≥—Ä–æ–∫–∞: ${activePlayer.username}`;
                 if (activePlayer.id === myPlayerId) {
                    messageDisplay.textContent = '–í–ê–® –•–û–î: –°–±—Ä–æ—Å–∏—Ç—å, –ß–µ–∫/–ö–æ–ª–ª –∏–ª–∏ –†–µ–π–∑?';
                    gameActions.style.display = 'flex';
                 }
             }
        } else {
             messageDisplay.textContent = '–û–∂–∏–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Ä–∞—É–Ω–¥–∞...';
        }
    });
    
    socket.on('return_to_lobby', (data) => {
        currentTableId = null;
        renderTableList(data.tables.filter(t => t.gameType === 'Poker'));
        showLobby();
        messageDisplay.textContent = '–í—ã –≤—ã—à–ª–∏ –∏–∑-–∑–∞ —Å—Ç–æ–ª–∞.';
    });

    socket.on('error_message', (msg) => {
        messageDisplay.textContent = `‚ùå –û—à–∏–±–∫–∞: ${msg}`;
    });
    
    // --- –ö–õ–ò–ï–ù–¢–°–ö–ò–ï –ö–ù–û–ü–ö–ò (–ü–û–ö–ï–†) ---
    function joinTable(tableId) { 
        socket.emit('join_table', { tableId: tableId }); 
    }
    
    createTableBtn.onclick = () => { 
        createTableForm.style.display = createTableForm.style.display === 'none' ? 'block' : 'none';
    };
    
    submitCreateTableBtn.onclick = () => {
        const maxPlayers = parseInt(maxPlayersInput.value);
        const minBet = parseInt(minBetInput.value);
        const isPrivate = confirm("–°–¥–µ–ª–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É –ø—Ä–∏–≤–∞—Ç–Ω–æ–π (—Å –ø–∞—Ä–æ–ª–µ–º)?");
        let password = null;
        if (isPrivate) password = prompt("–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å (–∏–ª–∏ –æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º):");
        
        if (maxPlayers >= 2 && minBet >= 1) {
            // –ö–õ–Æ–ß–ï–í–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ü–µ—Ä–µ–¥–∞–µ–º gameType
            socket.emit('create_table', { gameType: 'Poker', maxPlayers, minBet, isPrivate, password });
            createTableForm.style.display = 'none';
        } else {
             alert('–ù–µ–≤–µ—Ä–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–æ–º–Ω–∞—Ç—ã.');
        }
    };
    
    foldBtn.onclick = () => { socket.emit('fold', { tableId: currentTableId }); };
    checkCallBtn.onclick = () => { socket.emit('call_check', { tableId: currentTableId }); };
    raiseBtn.onclick = () => { 
        const amount = parseInt(raiseAmountInput.value);
        socket.emit('raise', { tableId: currentTableId, amount: amount }); 
    };
    
    leaveTableBtn.onclick = () => { 
        if (confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø–æ–∫–∏–Ω—É—Ç—å —Å—Ç–æ–ª?")) { 
            socket.emit('leave_table'); 
        } 
    };

    // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ---
    window.onload = () => {
        const storedBalance = localStorage.getItem('casinoBalance');
        if (storedBalance) {
            balance = parseInt(storedBalance);
        } else {
            balance = 1000; 
            localStorage.setItem('casinoBalance', balance);
        }
        updateDisplay();
    };

</script>
</body>
</html>